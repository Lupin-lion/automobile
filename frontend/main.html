<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Explore cars and bikes on The Marts Motors.">
  <meta name="keywords" content="cars, bikes, automobiles, buy cars, sell cars, The Marts Motors">
  <meta name="author" content="The Marts Motors">
  <title>Main Page | The Marts Motors</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: var(--text-color);
      position: relative;
    }

    :root {
      --background-color: #f4f7fb;
      --text-color: #2d3748;
      --primary-color: #1a73e8;
      --secondary-color: #f59e0b;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
    }

    [data-theme="dark"] {
      --background-color: #1a202c;
      --text-color: #e2e8f0;
      --primary-color: #63b3ed;
      --secondary-color: #f6ad55;
      --card-bg: #2d3748;
      --border-color: #4a5568;
    }

    header {
      background-color: var(--primary-color);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .logo {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      align-items: center;
    }

    nav ul li a {
      color: #fff;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    nav ul li a:hover {
      background-color: var(--secondary-color);
      color: #fff;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .theme-toggle:hover {
      color: var(--secondary-color);
    }

    .notification-bell {
      position: relative;
      background: none;
      border: none;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
    }

    .notification-bell .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #f44336;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      font-weight: bold;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .content-section {
      display: none;
      margin-top: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .content-section.active {
      display: block;
    }

    .featured-section {
      display: none;
      margin: 20px 0;
    }

    .featured-section.active {
      display: block;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .product-card {
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .product-card .details {
      padding: 15px;
      text-align: center;
    }

    .product-card .details h3 {
      margin: 0 0 10px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
    }

    .product-card .details .price {
      font-size: 18px;
      font-weight: 500;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .product-card .details .contact-btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: var(--secondary-color);
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }

    .product-card .details .contact-btn:hover {
      background-color: #d97706;
    }

    .interactions {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      border-top: 1px solid var(--border-color);
    }

    .interaction-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 5px;
      transition: color 0.3s ease;
    }

    .interaction-btn:hover {
      color: var(--secondary-color);
    }

    .interaction-count {
      font-size: 12px;
      color: #666;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .page-btn {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .page-btn:hover {
      background-color: var(--secondary-color);
    }

    #page-info {
      font-size: 16px;
      font-weight: 500;
    }

    footer {
      background-color: var(--primary-color);
      color: #fff;
      text-align: center;
      padding: 20px 0;
      margin-top: 40px;
    }

    .contact-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 10px;
      transition: transform 0.3s ease;
    }

    .contact-list a:hover .contact-icon {
      transform: scale(1.1);
    }

    .reset-btn {
      padding: 10px 20px;
      background-color: var(--secondary-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .reset-btn:hover {
      background-color: #d97706;
    }

    .filter-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-row {
      display: flex;
      gap: 15px;
      justify-content: space-between;
    }

    .filter-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    .filter-group select,
    .filter-group input {
      padding: 10px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: #fff;
      color: var(--text-color);
      transition: border-color 0.3s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
    }

    .loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 9999;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 50px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    #search-bar {
      width: 50%;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 50px 0 0 50px;
      outline: none;
      background: #f1f5f9;
      color: var(--text-color);
    }

    #search-bar:focus {
      background: #fff;
      box-shadow: inset 0 0 0 2px var(--primary-color);
    }

    #search-button, #clear-search {
      padding: 12px 20px;
      font-size: 16px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #search-button {
      border-radius: 0 50px 50px 0;
    }

    #clear-search {
      margin-left: 10px;
      border-radius: 50px;
    }

    #search-button:hover, #clear-search:hover {
      background-color: var(--secondary-color);
    }

    .messages-container {
      margin-top: 20px;
    }

    .message-thread {
      border-bottom: 1px solid var(--border-color);
      padding: 10px 0;
    }

    .message-thread p {
      margin: 5px 0;
    }

    .message-form {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .message-form input, .message-form select {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      flex: 1;
    }

    .message-form button {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .message-form button:hover {
      background-color: var(--secondary-color);
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 10px;
      }

      nav ul {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .search-container {
        flex-direction: column;
        gap: 10px;
      }

      #search-bar {
        width: 100%;
        border-radius: 50px;
      }

      #search-button {
        border-radius: 50px;
      }

      .filter-row {
        flex-direction: column;
        gap: 10px;
      }

      .interactions {
        flex-wrap: wrap;
        gap: 10px;
      }

      .message-form {
        flex-direction: column;
      }
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize DOM elements
      const sections = document.querySelectorAll(".content-section");
      const featuredSection = document.querySelector(".featured-section");
      const authForms = document.getElementById('auth-forms');
      const userInfo = document.getElementById('user-info');
      const navLinks = document.querySelectorAll("nav ul li a[data-section]");
      const spinner = document.getElementById("loading-spinner");

      // Navigation handler
      navLinks.forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const sectionId = link.getAttribute("data-section");
          const section = document.getElementById(sectionId);

          // Hide all sections and show the selected one
          sections.forEach(sec => sec.classList.remove("active"));
          section.classList.add("active");

          // Show Featured Products only on Listings section
          if (sectionId === "listings") {
            featuredSection.classList.add("active");
          } else {
            featuredSection.classList.remove("active");
          }

          // Handle Profile section visibility based on login state
          const token = localStorage.getItem('token');
          if (sectionId === "profile") {
            if (!token) {
              authForms.style.display = 'block';
              userInfo.style.display = 'none';
            } else {
              authForms.style.display = 'none';
              userInfo.style.display = 'block';
            }
          } else {
            authForms.style.display = 'none';
            userInfo.style.display = 'none';
          }

          // Scroll to the section
          window.scrollTo({ top: section.offsetTop - 80, behavior: "smooth" });
        });
      });

      // Initialize variables for Listings
      const filterType = document.getElementById("filter-type");
      const filterPrice = document.getElementById("filter-price");
      const filterMake = document.getElementById("filter-make");
      const filterOrigin = document.getElementById("filter-origin");
      const filterYear = document.getElementById("filter-year");
      const sortOptions = document.getElementById("sort-options");
      const productGrid = document.querySelector(".product-grid");

      let currentPage = 1;
      const itemsPerPage = 2;
      let products = [];
      let filteredProducts = [];

      // Authentication state
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      // Update navigation based on authentication state
      const createProfileLink = document.getElementById('create-profile-link');
      const loginLink = document.getElementById('login-link');
      const logoutLink = document.getElementById('logout-link');
      const createListingLink = document.getElementById('create-listing-link');
      const messagesLink = document.getElementById('messages-link');
      const createListingSection = document.getElementById('create-listing');
      const messagesSection = document.getElementById('messages');
      const notificationBell = document.getElementById('notification-bell');

      if (token && user) {
        createProfileLink.style.display = 'none';
        loginLink.style.display = 'none';
        logoutLink.style.display = 'inline';
        createListingLink.style.display = 'inline';
        messagesLink.style.display = 'inline';
        createListingSection.style.display = 'block';
        messagesSection.style.display = 'block';
        notificationBell.style.display = 'inline';
        authForms.style.display = 'none';
        userInfo.style.display = 'block';
        document.getElementById('profile-title').textContent = 'User Profile';
        document.getElementById('username').textContent = user.username;
        document.getElementById('user-email').textContent = user.email;
      } else {
        createProfileLink.style.display = 'inline';
        loginLink.style.display = 'inline';
        logoutLink.style.display = 'none';
        createListingLink.style.display = 'none';
        messagesLink.style.display = 'none';
        createListingSection.style.display = 'none';
        messagesSection.style.display = 'none';
        notificationBell.style.display = 'none';
        authForms.style.display = 'block';
        userInfo.style.display = 'none';
      }

      // Logout functionality
      logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.reload();
      });

      // Toggle between login and register forms
      const showRegisterLink = document.getElementById('show-register');
      const showLoginLink = document.getElementById('show-login');

      showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
      });

      showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
      });

      // Handle registration
      const registerForm = document.getElementById('register-form-element');
      const registerButton = registerForm.querySelector('button[type="submit"]');
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const messageElement = document.getElementById('register-message');

        registerButton.disabled = true;
        messageElement.textContent = 'Registering...';
        messageElement.style.color = 'blue';

        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/users/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password }),
          });
          const data = await response.json();
          if (response.ok) {
            messageElement.style.color = 'green';
            messageElement.textContent = data.message;
            setTimeout(() => {
              document.getElementById('register-form').style.display = 'none';
              document.getElementById('login-form').style.display = 'block';
              messageElement.textContent = '';
            }, 2000);
          } else {
            messageElement.style.color = 'red';
            messageElement.textContent = data.message || 'Error registering user';
          }
        } catch (error) {
          messageElement.style.color = 'red';
          messageElement.textContent = 'Error connecting to the server: ' + error.message;
        } finally {
          registerButton.disabled = false;
        }
      });

      // Handle login
      const loginForm = document.getElementById('login-form-element');
      const loginButton = loginForm.querySelector('button[type="submit"]');
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const messageElement = document.getElementById('login-message');

        loginButton.disabled = true;
        messageElement.textContent = 'Logging in...';
        messageElement.style.color = 'blue';

        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/users/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            messageElement.style.color = 'green';
            messageElement.textContent = 'Login successful! Reloading...';
            setTimeout(() => window.location.reload(), 1000);
          } else {
            messageElement.style.color = 'red';
            messageElement.textContent = data.message || 'Error logging in';
          }
        } catch (error) {
          messageElement.style.color = 'red';
          messageElement.textContent = 'Error connecting to the server: ' + error.message;
        } finally {
          loginButton.disabled = false;
        }
      });

      // Handle create listing
      const createListingForm = document.getElementById('create-listing-form');
      createListingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = document.getElementById('vehicle-type').value;
        const make = document.getElementById('vehicle-make').value;
        const model = document.getElementById('vehicle-model').value;
        const price = parseInt(document.getElementById('vehicle-price').value);
        const origin = document.getElementById('vehicle-origin').value;
        const year = parseInt(document.getElementById('vehicle-year').value);
        const image = document.getElementById('vehicle-image').value;
        const contact = document.getElementById('vehicle-contact').value;
        const featured = document.getElementById('vehicle-featured').checked;
        const messageElement = document.getElementById('create-listing-message');

        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/vehicles', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify({ type, make, model, price, origin, year, image, contact, featured }),
          });
          const data = await response.json();
          if (response.ok) {
            messageElement.style.color = 'green';
            messageElement.textContent = 'Vehicle created successfully';
            fetchProducts();
            fetchFeaturedProducts();
            createListingForm.reset();
          } else {
            messageElement.style.color = 'red';
            messageElement.textContent = data.message || 'Error creating vehicle';
          }
        } catch (error) {
          messageElement.style.color = 'red';
          messageElement.textContent = 'Error connecting to the server: ' + error.message;
        }
      });

      // Navigate to Create Listing from Profile section
      const createListingButton = document.getElementById('create-listing-button');
      createListingButton.addEventListener('click', () => {
        sections.forEach(sec => sec.classList.remove("active"));
        document.getElementById('create-listing').classList.add('active');
        featuredSection.classList.remove("active");
        authForms.style.display = 'none';
        userInfo.style.display = 'none';
      });

      // Fetch products from the backend
      async function fetchProducts() {
        spinner.style.display = "block";
        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/vehicles');
          if (!response.ok) throw new Error('Failed to fetch vehicles');
          products = await response.json();
          filteredProducts = [...products];
          currentPage = 1;
          document.getElementById("page-info").textContent = `Page ${currentPage}`;
          renderProducts(paginateProducts(filteredProducts));
        } catch (error) {
          console.error('Error fetching vehicles:', error);
          productGrid.innerHTML = '<p style="text-align: center; color: red;">Error loading vehicles. Please try again later.</p>';
        } finally {
          spinner.style.display = "none";
        }
      }

      function paginateProducts(products) {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        return products.slice(startIndex, endIndex);
      }

      document.querySelectorAll(".page-btn").forEach(button => {
        button.addEventListener("click", () => {
          const direction = button.getAttribute("data-page");
          const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

          if (direction === "prev" && currentPage > 1) {
            currentPage--;
          } else if (direction === "next" && currentPage < totalPages) {
            currentPage++;
          }

          document.getElementById("page-info").textContent = `Page ${currentPage}`;
          renderProducts(paginateProducts(filteredProducts));
        });
      });

      function renderProducts(products) {
        const noResults = document.getElementById("no-results");
        productGrid.innerHTML = "";

        if (products.length === 0) {
          noResults.style.display = "block";
        } else {
          noResults.style.display = "none";
          products.forEach(product => {
            const likeKey = `like_${product.id}`;
            const commentKey = `comment_${product.id}`;
            const repostKey = `repost_${product.id}`;
            const shareKey = `share_${product.id}`;

            const likeCount = parseInt(localStorage.getItem(likeKey) || '0');
            const commentCount = parseInt(localStorage.getItem(commentKey) || '0');
            const repostCount = parseInt(localStorage.getItem(repostKey) || '0');
            const shareCount = parseInt(localStorage.getItem(shareKey) || '0');

            const productCard = `
              <div class="product-card">
                <img src="${product.image}" alt="${product.make} ${product.model}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                <div class="details">
                  <h3>${product.make} ${product.model}</h3>
                  <p class="price">$${product.price.toLocaleString()}</p>
                  <p class="year">Year: ${product.year}</p>
                  <p class="origin">Origin: ${product.origin.charAt(0).toUpperCase() + product.origin.slice(1)}</p>
                  <a href="${product.contact || '#'}" target="_blank" class="contact-btn" aria-label="Contact the owner via WhatsApp">Contact Owner</a>
                </div>
                <div class="interactions">
                  <button class="interaction-btn like-btn" data-id="${product.id}">
                    ‚ù§Ô∏è Like <span class="interaction-count">${likeCount}</span>
                  </button>
                  <button class="interaction-btn comment-btn" data-id="${product.id}">
                    üí¨ Comment <span class="interaction-count">${commentCount}</span>
                  </button>
                  <button class="interaction-btn repost-btn" data-id="${product.id}">
                    üîÑ Repost <span class="interaction-count">${repostCount}</span>
                  </button>
                  <button class="interaction-btn share-btn" data-id="${product.id}">
                    üì§ Share <span class="interaction-count">${shareCount}</span>
                  </button>
                </div>
              </div>
            `;
            productGrid.innerHTML += productCard;
          });

          document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = btn.getAttribute('data-id');
              const key = `like_${id}`;
              let count = parseInt(localStorage.getItem(key) || '0');
              count++;
              localStorage.setItem(key, count);
              btn.querySelector('.interaction-count').textContent = count;
            });
          });

          document.querySelectorAll('.comment-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = btn.getAttribute('data-id');
              const key = `comment_${id}`;
              let count = parseInt(localStorage.getItem(key) || '0');
              count++;
              localStorage.setItem(key, count);
              btn.querySelector('.interaction-count').textContent = count;
              alert('Comment feature coming soon!');
            });
          });

          document.querySelectorAll('.repost-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = btn.getAttribute('data-id');
              const key = `repost_${id}`;
              let count = parseInt(localStorage.getItem(key) || '0');
              count++;
              localStorage.setItem(key, count);
              btn.querySelector('.interaction-count').textContent = count;
            });
          });

          document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = btn.getAttribute('data-id');
              const key = `share_${id}`;
              let count = parseInt(localStorage.getItem(key) || '0');
              count++;
              localStorage.setItem(key, count);
              btn.querySelector('.interaction-count').textContent = count;
              alert('Share feature coming soon!');
            });
          });
        }
      }

      function filterProducts() {
        spinner.style.display = "block";
        setTimeout(() => {
          const typeValue = filterType.value;
          const priceValue = filterPrice.value;
          const makeValue = filterMake.value;
          const originValue = filterOrigin.value;
          const yearValue = filterYear.value;

          filteredProducts = products.filter(product => {
            const matchesType = typeValue === "all" || product.type === typeValue;
            const matchesPrice =
              priceValue === "all" ||
              (priceValue === "low" && product.price < 10000) ||
              (priceValue === "medium" && product.price >= 10000 && product.price <= 20000) ||
              (priceValue === "high" && product.price > 20000);
            const matchesMake = makeValue === "all" || product.make.toLowerCase() === makeValue;
            const matchesOrigin = originValue === "all" || product.origin === originValue;
            const matchesYear = yearValue === "all" || product.year.toString() === yearValue;

            return matchesType && matchesPrice && matchesMake && matchesOrigin && matchesYear;
          });

          currentPage = 1;
          document.getElementById("page-info").textContent = `Page ${currentPage}`;
          renderProducts(paginateProducts(filteredProducts));
          spinner.style.display = "none";
        }, 500);
      }

      filterType.addEventListener("change", filterProducts);
      filterPrice.addEventListener("change", filterProducts);
      filterMake.addEventListener("change", filterProducts);
      filterOrigin.addEventListener("change", filterProducts);
      filterYear.addEventListener("change", filterProducts);

      const resetFiltersButton = document.getElementById("reset-filters");
      resetFiltersButton.addEventListener("click", () => {
        filterType.value = "all";
        filterPrice.value = "all";
        filterMake.value = "all";
        filterOrigin.value = "all";
        filterYear.value = "all";
        filterProducts();
      });

      sortOptions.addEventListener("change", () => {
        const sortValue = sortOptions.value;
        if (sortValue === "price-asc") {
          filteredProducts.sort((a, b) => a.price - b.price);
        } else if (sortValue === "price-desc") {
          filteredProducts.sort((a, b) => b.price - b.price);
        } else if (sortValue === "year-asc") {
          filteredProducts.sort((a, b) => a.year - b.year);
        } else if (sortValue === "year-desc") {
          filteredProducts.sort((a, b) => b.year - a.year);
        }
        renderProducts(paginateProducts(filteredProducts));
      });

      // Fetch and render Featured Products
      const featuredGrid = document.getElementById("featured-products");
      async function fetchFeaturedProducts() {
        if (!featuredGrid) return;
        spinner.style.display = "block";
        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/vehicles');
          if (!response.ok) throw new Error('Failed to fetch featured products');
          const vehicles = await response.json();
          const featuredProducts = vehicles.filter(vehicle => vehicle.featured).slice(0, 2);
          featuredGrid.innerHTML = "";
          if (featuredProducts.length === 0) {
            featuredGrid.innerHTML = '<p style="text-align: center; color: var(--text-color);">No featured products available. Create a listing and mark it as featured!</p>';
          } else {
            featuredProducts.forEach(product => {
              const featuredCard = `
                <div class="product-card">
                  <img src="${product.image}" alt="${product.make} ${product.model}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                  <div class="details">
                    <h3>${product.make} ${product.model}</h3>
                    <p class="price">$${product.price.toLocaleString()}</p>
                    <p class="year">Year: ${product.year}</p>
                  </div>
                </div>
              `;
              featuredGrid.innerHTML += featuredCard;
            });
          }
        } catch (error) {
          console.error('Error fetching featured products:', error);
          featuredGrid.innerHTML = '<p style="text-align: center; color: red;">Error loading featured products.</p>';
        } finally {
          spinner.style.display = "none";
        }
      }

      // Theme toggle
      const themeToggle = document.querySelector(".theme-toggle");
      themeToggle.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        themeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
      });

      // Search functionality
      const searchBar = document.getElementById("search-bar");
      const searchButton = document.getElementById("search-button");
      const clearSearchButton = document.getElementById("clear-search");

      clearSearchButton.addEventListener("click", () => {
        searchBar.value = "";
        filteredProducts = [...products];
        currentPage = 1;
        document.getElementById("page-info").textContent = `Page ${currentPage}`;
        renderProducts(paginateProducts(filteredProducts));
      });

      searchButton.addEventListener("click", () => {
        spinner.style.display = "block";
        setTimeout(() => {
          const query = searchBar.value.toLowerCase();
          filteredProducts = products.filter(product =>
            product.make.toLowerCase().includes(query) ||
            product.model.toLowerCase().includes(query) ||
            product.price.toString().includes(query)
          );
          currentPage = 1;
          document.getElementById("page-info").textContent = `Page ${currentPage}`;
          renderProducts(paginateProducts(filteredProducts));
          spinner.style.display = "none";
        }, 1000);
      });

      searchBar.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        filteredProducts = products.filter(product =>
          product.make.toLowerCase().includes(query) ||
          product.model.toLowerCase().includes(query) ||
          product.price.toString().includes(query)
        );
        currentPage = 1;
        document.getElementById("page-info").textContent = `Page ${currentPage}`;
        renderProducts(paginateProducts(filteredProducts));
      });

      // Messages and Notifications
      const messageThreads = document.getElementById('message-threads');
      const messageForm = document.getElementById('message-form');
      const notificationBell = document.getElementById('notification-bell');
      const notificationCount = document.getElementById('notification-count');

      async function populateRecipients() {
        const recipientSelect = document.getElementById('message-recipient');
        if (!recipientSelect || !user) return;

        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/users');
          if (!response.ok) throw new Error('Failed to fetch users');
          const users = await response.json();
          recipientSelect.innerHTML = '<option value="">Select a recipient</option>';
          users.forEach(u => {
            if (u.email !== user.email) {
              const option = document.createElement('option');
              option.value = u.email;
              option.textContent = u.username;
              recipientSelect.appendChild(option);
            }
          });
        } catch (error) {
          console.error('Error fetching users:', error);
        }
      }

      async function fetchMessages() {
        if (!user) return;
        try {
          const response = await fetch(`https://automobile-backend-dcd22d288ee3.herokuapp.com/api/messages?userEmail=${user.email}`);
          const messages = await response.json();
          renderMessages(messages);
          updateNotifications(messages);
        } catch (error) {
          console.error('Error fetching messages:', error);
          messageThreads.innerHTML = '<p style="color: red;">Error loading messages.</p>';
        }
      }

      function renderMessages(messages) {
        messageThreads.innerHTML = '';
        messages.forEach(msg => {
          const messageElement = `
            <div class="message-thread">
              <p><strong>${msg.sender === user.email ? 'You' : msg.sender}:</strong> ${msg.content}</p>
              <p style="font-size: 12px; color: #666;">${new Date(msg.timestamp).toLocaleString()}</p>
            </div>
          `;
          messageThreads.innerHTML += messageElement;
        });
      }

      function updateNotifications(messages) {
        if (!user || !notificationCount) return;
        const unreadMessages = messages.filter(msg => msg.recipient === user.email && !localStorage.getItem(`read_${msg.id}`));
        const unreadCount = unreadMessages.length;
        notificationCount.textContent = unreadCount;
        notificationCount.style.display = unreadCount > 0 ? 'inline' : 'none';

        if (unreadCount > 0) {
          notificationBell.addEventListener('click', () => {
            sections.forEach(sec => sec.classList.remove("active"));
            document.getElementById('messages').classList.add('active');
            featuredSection.classList.remove("active");
            authForms.style.display = 'none';
            userInfo.style.display = 'none';
            unreadMessages.forEach(msg => {
              localStorage.setItem(`read_${msg.id}`, 'true');
            });
            notificationCount.textContent = '0';
            notificationCount.style.display = 'none';
          }, { once: true });
        }
      }

      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!user) {
          alert('Please log in to send messages.');
          return;
        }
        const recipient = document.getElementById('message-recipient').value;
        const content = document.getElementById('message-content').value;

        if (!recipient || !content) {
          alert('Please select a recipient and enter a message.');
          return;
        }

        try {
          const response = await fetch('https://automobile-backend-dcd22d288ee3.herokuapp.com/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sender: user.email, recipient, content }),
          });
          if (response.ok) {
            document.getElementById('message-content').value = '';
            fetchMessages();
          } else {
            alert('Error sending message.');
          }
        } catch (error) {
          console.error('Error sending message:', error);
          alert('Error sending message.');
        }
      });

      // Initialize the page
      fetchProducts();
      fetchFeaturedProducts();
      if (token && user) {
        fetchMessages();
        populateRecipients();
        setInterval(fetchMessages, 30000);
      }

      const listingsSection = document.getElementById("listings");
      listingsSection.classList.add("active");
      featuredSection.classList.add("active");

      // Fallback to hide spinner after 5 seconds
      setTimeout(() => {
        spinner.style.display = "none";
      }, 5000);
    });

    function navigateToWelcomePage() {
      window.location.href = "index.html";
    }
  </script>
</head>
<body>
  <header>
    <div class="logo">The Marts Motors</div>
    <nav>
      <ul>
        <li><a href="#" onclick="navigateToWelcomePage()">Home</a></li>
        <li><a href="#" data-section="listings">Listings</a></li>
        <li><a href="#" data-section="profile" id="create-profile-link">Profile</a></li>
        <li><a href="#" id="login-link">Log In</a></li>
        <li><a href="#" data-section="create-listing" id="create-listing-link" style="display: none;">Create Listing</a></li>
        <li><a href="#" data-section="messages" id="messages-link" style="display: none;">Messages</a></li>
        <li><a href="#" id="logout-link" style="display: none;">Log Out</a></li>
        <li><a href="#" data-section="about">About</a></li>
        <li><a href="#" data-section="contact">Contact Us</a></li>
      </ul>
    </nav>
    <div>
      <button class="notification-bell" id="notification-bell" style="display: none;">
        üîî <span class="badge" id="notification-count" style="display: none;">0</span>
      </button>
      <button class="theme-toggle">üåô</button>
    </div>
  </header>

  <main>
    <div class="search-container">
      <input type="text" id="search-bar" placeholder="Search by make, model, or price..." aria-label="Search">
      <button id="search-button">Search</button>
      <button id="clear-search">Clear</button>
    </div>

    <div class="featured-section">
      <h2>Featured Products</h2>
      <div class="product-grid" id="featured-products"></div>
    </div>

    <div class="loading-spinner" id="loading-spinner"></div>

    <div id="listings" class="content-section">
      <h2>Available Cars and Bikes</h2>
      <div class="filter-container">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filter-type">Type:</label>
            <select id="filter-type">
              <option value="all">All</option>
              <option value="car">Cars</option>
              <option value="bike">Bikes</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-price">Price:</label>
            <select id="filter-price">
              <option value="all">All</option>
              <option value="low">Below $10,000</option>
              <option value="medium">$10,000 - $20,000</option>
              <option value="high">Above $20,000</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label for="filter-make">Make:</label>
            <select id="filter-make">
              <option value="all">All</option>
              <option value="toyota">Toyota</option>
              <option value="ford">Ford</option>
              <option value="yamaha">Yamaha</option>
              <option value="suzuki">Suzuki</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-origin">Origin:</label>
            <select id="filter-origin">
              <option value="all">All</option>
              <option value="foreign">Foreign</option>
              <option value="local">Local</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label for="filter-year">Year:</label>
            <select id="filter-year">
              <option value="all">All</option>
              <option value="2020">2020</option>
              <option value="2018">2018</option>
              <option value="2015">2015</option>
              <option value="2010">2010</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sort-options">Sort By:</label>
            <select id="sort-options">
              <option value="default">Default</option>
              <option value="price-asc">Price: Low to High</option>
              <option value="price-desc">Price: High to Low</option>
              <option value="year-asc">Year: Oldest First</option>
              <option value="year-desc">Year: Newest First</option>
            </select>
          </div>
        </div>
        <div class="filter-actions">
          <button id="reset-filters" class="reset-btn" aria-label="Reset all filters">Reset Filters</button>
        </div>
      </div>
      <div class="product-grid"></div>
      <div id="no-results" style="display: none; text-align: center; color: var(--text-color); font-size: 18px;">No results found.</div>
      <div class="pagination">
        <button class="page-btn" data-page="prev">Previous</button>
        <span id="page-info">Page 1</span>
        <button class="page-btn" data-page="next">Next</button>
      </div>
    </div>

    <div id="profile" class="content-section">
      <h2 id="profile-title">User Profile</h2>
      <div id="user-info" style="display: none;">
        <p>Welcome, <span id="username"></span>!</p>
        <p>Email: <span id="user-email"></span></p>
        <button id="create-listing-button" class="reset-btn">Create a New Listing</button>
      </div>
      <div id="auth-forms">
        <div id="register-form" style="display: none;">
          <h3>Register</h3>
          <form id="register-form-element">
            <div class="filter-group">
              <label for="register-username">Username:</label>
              <input type="text" id="register-username" name="register-username" required>
            </div>
            <div class="filter-group">
              <label for="register-email">Email:</label>
              <input type="email" id="register-email" name="register-email" required>
            </div>
            <div class="filter-group">
              <label for="register-password">Password:</label>
              <input type="password" id="register-password" name="register-password" required>
            </div>
            <button type="submit" class="reset-btn">Register</button>
          </form>
          <p id="register-message"></p>
          <p>Already have an account? <a href="#" id="show-login">Log In</a></p>
        </div>
        <div id="login-form">
          <h3>Log In</h3>
          <form id="login-form-element">
            <div class="filter-group">
              <label for="login-email">Email:</label>
              <input type="email" id="login-email" name="login-email" required>
            </div>
            <div class="filter-group">
              <label for="login-password">Password:</label>
              <input type="password" id="login-password" name="login-password" required>
            </div>
            <button type="submit" class="reset-btn">Log In</button>
          </form>
          <p id="login-message"></p>
          <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
        </div>
      </div>
    </div>

    <div id="create-listing" class="content-section" style="display: none;">
      <h2>Create a New Listing</h2>
      <form id="create-listing-form">
        <div class="filter-group">
          <label for="vehicle-type">Type:</label>
          <select id="vehicle-type" required>
            <option value="car">Car</option>
            <option value="bike">Bike</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="vehicle-make">Make:</label>
          <input type="text" id="vehicle-make" required>
        </div>
        <div class="filter-group">
          <label for="vehicle-model">Model:</label>
          <input type="text" id="vehicle-model" required>
        </div>
        <div class="filter-group">
          <label for="vehicle-price">Price:</label>
          <input type="number" id="vehicle-price" required>
        </div>
        <div class="filter-group">
          <label for="vehicle-origin">Origin:</label>
          <select id="vehicle-origin" required>
            <option value="foreign">Foreign</option>
            <option value="local">Local</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="vehicle-year">Year:</label>
          <input type="number" id="vehicle-year" required>
        </div>
        <div class="filter-group">
          <label for="vehicle-image">Image URL:</label>
          <input type="text" id="vehicle-image">
        </div>
        <div class="filter-group">
          <label for="vehicle-contact">Contact URL:</label>
          <input type="text" id="vehicle-contact">
        </div>
        <div class="filter-group">
          <label for="vehicle-featured">Featured:</label>
          <input type="checkbox" id="vehicle-featured">
        </div>
        <button type="submit" class="reset-btn">Create Listing</button>
      </form>
      <p id="create-listing-message"></p>
    </div>

    <div id="messages" class="content-section" style="display: none;">
      <h2>Messages</h2>
      <div class="messages-container">
        <div id="message-threads"></div>
        <form id="message-form" class="message-form">
          <select id="message-recipient" required>
            <option value="">Select a recipient</option>
          </select>
          <input type="text" id="message-content" placeholder="Type your message..." required>
          <button type="submit">Send</button>
        </form>
      </div>
    </div>

    <div id="about" class="content-section">
      <h2>About The Marts Motors</h2>
      <p>Welcome to <strong>The Marts Motors</strong>, your trusted partner in the world of automobiles. Whether you're searching for your dream car, a sleek bike, or looking to sell your vehicle, we‚Äôre here to make the process seamless, secure, and enjoyable.</p>
      <p>At <strong>The Marts Motors</strong>, we‚Äôre more than just a marketplace‚Äîwe‚Äôre a community of automotive enthusiasts who share a passion for excellence and innovation. Our platform is designed to connect buyers and sellers effortlessly, ensuring every transaction is smooth and rewarding.</p>
      <h3>Why Choose The Marts Motors?</h3>
      <ul>
        <li><strong>Extensive Selection:</strong> From luxury cars to sporty bikes, we offer a wide range of vehicles to suit every taste and budget.</li>
        <li><strong>Secure Transactions:</strong> Your safety is our priority. We provide a secure platform for buying and selling vehicles with confidence.</li>
        <li><strong>Easy-to-Use Interface:</strong> Our intuitive design makes it simple to browse, filter, and connect with sellers or buyers.</li>
        <li><strong>Community-Driven:</strong> Join a thriving network of car and bike enthusiasts who share your passion.</li>
      </ul>
      <h3>Our Mission</h3>
      <p>At <strong>The Marts Motors</strong>, our mission is to revolutionize the automotive marketplace by bridging the gap between buyers and sellers. We aim to empower our users with the tools and resources they need to make informed decisions and drive away with confidence.</p>
      <p>Whether you're buying your first car, upgrading to a premium bike, or selling a vehicle you‚Äôve cherished, <strong>The Marts Motors</strong> is here to make the journey smooth, exciting, and rewarding. Let‚Äôs drive the future together!</p>
    </div>

    <div id="contact" class="content-section">
      <h2>Contact Us</h2>
      <ul class="contact-list">
        <li><a href="https://wa.me/254799582173" target="_blank"><img src="https://images.unsplash.com/photo-1611162617213-7d7a39e9b1d7" alt="WhatsApp" class="contact-icon">WhatsApp</a></li>
        <li><a href="mailto:themartswriters@gmail.com"><img src="https://images.unsplash.com/photo-1596526131083-5a2a1283dd02" alt="Email" class="contact-icon">Email</a></li>
        <li><a href="https://gracetech-eng.github.io/themarts/" target="_blank"><img src="https://images.unsplash.com/photo-1626785774573-4b7b86f7d90f" alt="The Marts Web" class="contact-icon">The Marts Web</a></li>
      </ul>
    </div>
  </main>

  <footer>
    <p>The Marts Motors ¬© 2025 | Connect and Share</p>
  </footer>
</body>
</html>