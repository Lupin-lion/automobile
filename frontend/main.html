<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Marts Motors</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        nav {
            display: flex;
            justify-content: space-around;
            background-color: #444;
            padding: 1rem;
            flex-wrap: wrap;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
        }
        nav a:hover {
            background-color: #555;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section {
            display: none;
            margin-bottom: 2rem;
        }
        .section.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        .card h3 {
            margin: 0.5rem 0;
            font-size: 1.2rem;
        }
        .card p {
            color: #666;
            margin: 0.5rem 0;
            flex-grow: 1;
        }
        .search-bar {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .search-bar input, .search-bar select {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        .form-container h2 {
            margin-top: 0;
        }
        .form-container .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-container input[type="file"] {
            padding: 0;
        }
        .form-container .full-width {
            grid-column: 1 / -1;
        }
        .form-container button {
            background-color: #333;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-container button:hover {
            background-color: #555;
        }
        .error {
            color: red;
            font-size: 0.9rem;
        }
        .success {
            color: green;
            font-size: 0.9rem;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
        }
        .pagination button:disabled {
            background: #eee;
            cursor: not-allowed;
        }
        .social-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        .social-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }
        .comment {
            background: #f9f9f9;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        .comment.reply {
            margin-left: 2rem;
        }
        .comment-form {
            margin-top: 1rem;
        }
        .comment-form textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .comment-form button {
            background-color: #333;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .profile-preview {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .profile-preview img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .user-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        .message-container {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
        }
        .message.sent {
            background: #d4edda;
            margin-left: 20%;
        }
        .message.received {
            background: #e9ecef;
            margin-right: 20%;
        }
        .status-pending {
            color: orange;
            font-weight: bold;
        }
        .status-verified {
            color: green;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .form-container .form-grid {
                grid-template-columns: 1fr;
            }
            .search-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>The Marts Motors</h1>
    </header>
    <nav>
        <a href="#" onclick="showSection('home')">Home</a>
        <a href="#" onclick="showSection('listings')">Listings</a>
        <a href="#" onclick="showSection('profile')">Profile</a>
        <a href="#" onclick="showSection('create-listing')" id="createListingLink" style="display: none;">Create Listing</a>
        <a href="#" onclick="showSection('users')" id="usersLink" style="display: none;">Users</a>
        <a href="#" onclick="logout()" id="logoutLink" style="display: none;">Log Out</a>
        <a href="#" onclick="showSection('contact')">Contact Us</a>
    </nav>
    <div class="container">
        <div id="home" class="section active">
            <h2>Welcome to The Marts Motors</h2>
            <p>Explore our featured vehicles below.</p>
            <div id="featured" class="grid"></div>
        </div>
        <div id="listings" class="section">
            <h2>Vehicle Listings</h2>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search by make, model, or description">
                <select id="typeFilter">
                    <option value="">All Types</option>
                    <option value="Car">Car</option>
                    <option value="Bike">Bike</option>
                </select>
                <select id="priceSort">
                    <option value="">Sort by Price</option>
                    <option value="asc">Low to High</option>
                    <option value="desc">High to Low</option>
                </select>
                <select id="originFilter">
                    <option value="">All Origins</option>
                    <option value="Foreign">Foreign</option>
                    <option value="Local">Local</option>
                </select>
                <select id="yearSort">
                    <option value="">Sort by Year</option>
                    <option value="asc">Old to New</option>
                    <option value="desc">New to Old</option>
                </select>
            </div>
            <div id="listingsGrid" class="grid"></div>
            <div class="pagination">
                <button onclick="changePage(-1)" id="prevPage">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button onclick="changePage(1)" id="nextPage">Next</button>
            </div>
        </div>
        <div id="profile" class="section">
            <h2>Profile</h2>
            <div id="profileInfo" style="display: none;">
                <div class="profile-preview">
                    <img id="profilePicture" src="https://via.placeholder.com/100" alt="Profile Picture">
                    <div>
                        <h3 id="profileUsername"></h3>
                        <p id="profileBio"></p>
                        <p id="profileLocation"></p>
                    </div>
                </div>
                <button onclick="showEditProfileForm()">Edit Profile</button>
            </div>
            <div id="authForms">
                <div class="form-container" id="loginForm">
                    <h2>Log In</h2>
                    <p class="error" id="loginError"></p>
                    <p class="success" id="loginSuccess"></p>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button onclick="login()">Log In</button>
                    <p>Don't have an account? <a href="#" onclick="showRegisterForm()">Create Profile</a></p>
                </div>
                <div class="form-container" id="registerForm" style="display: none;">
                    <h2>Create Your Profile</h2>
                    <p class="error" id="registerError"></p>
                    <p class="success" id="registerSuccess"></p>
                    <div class="form-grid">
                        <div>
                            <label for="registerUsername">Username *</label>
                            <input type="text" id="registerUsername" placeholder="Choose a username" required>
                        </div>
                        <div>
                            <label for="registerEmail">Email *</label>
                            <input type="email" id="registerEmail" placeholder="Your email" required>
                        </div>
                        <div>
                            <label for="registerPassword">Password *</label>
                            <input type="password" id="registerPassword" placeholder="Create a password" required>
                        </div>
                        <div>
                            <label for="registerCity">City</label>
                            <input type="text" id="registerCity" placeholder="Your city (optional)">
                        </div>
                        <div>
                            <label for="registerCountry">Country</label>
                            <input type="text" id="registerCountry" placeholder="Your country (optional)">
                        </div>
                        <div class="full-width">
                            <label for="registerBio">Bio</label>
                            <textarea id="registerBio" placeholder="Tell us about yourself (optional)" rows="4"></textarea>
                        </div>
                        <div class="full-width">
                            <label for="registerProfilePicture">Profile Picture</label>
                            <input type="url" id="registerProfilePicture" placeholder="Image URL (optional)">
                        </div>
                    </div>
                    <button onclick="register()">Create Profile</button>
                    <p>Already have an account? <a href="#" onclick="showLoginForm()">Log In</a></p>
                </div>
                <div class="form-container" id="editProfileForm" style="display: none;">
                    <h2>Edit Profile</h2>
                    <p class="error" id="editProfileError"></p>
                    <p class="success" id="editProfileSuccess"></p>
                    <div class="form-grid">
                        <div>
                            <label for="editUsername">Username *</label>
                            <input type="text" id="editUsername" required>
                        </div>
                        <div>
                            <label for="editEmail">Email *</label>
                            <input type="email" id="editEmail" required>
                        </div>
                        <div>
                            <label for="editCity">City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div>
                            <label for="editCountry">Country</label>
                            <input type="text" id="editCountry">
                        </div>
                        <div class="full-width">
                            <label for="editBio">Bio</label>
                            <textarea id="editBio" rows="4"></textarea>
                        </div>
                        <div class="full-width">
                            <label for="editProfilePicture">Profile Picture</label>
                            <input type="url" id="editProfilePicture">
                        </div>
                    </div>
                    <button onclick="updateProfile()">Save Changes</button>
                    <button onclick="showProfileInfo()">Cancel</button>
                </div>
            </div>
        </div>
        <div id="create-listing" class="section">
            <h2>Create a New Listing</h2>
            <div class="form-container">
                <p class="error" id="createError"></p>
                <p class="success" id="createSuccess"></p>
                <div class="form-grid">
                    <div>
                        <label for="vehicleType">Type *</label>
                        <select id="vehicleType" required>
                            <option value="">Select Type</option>
                            <option value="Car">Car</option>
                            <option value="Bike">Bike</option>
                        </select>
                    </div>
                    <div>
                        <label for="make">Make *</label>
                        <input type="text" id="make" placeholder="e.g., Toyota" required>
                    </div>
                    <div>
                        <label for="model">Model *</label>
                        <input type="text" id="model" placeholder="e.g., Corolla" required>
                    </div>
                    <div>
                        <label for="price">Price ($) *</label>
                        <input type="number" id="price" min="1" placeholder="e.g., 15000" required>
                    </div>
                    <div>
                        <label for="origin">Origin *</label>
                        <select id="origin" required>
                            <option value="">Select Origin</option>
                            <option value="Foreign">Foreign</option>
                            <option value="Local">Local</option>
                        </select>
                    </div>
                    <div>
                        <label for="year">Year *</label>
                        <input type="number" id="year" min="1900" max="2025" placeholder="e.g., 2020" required>
                    </div>
                    <div>
                        <label for="condition">Condition *</label>
                        <select id="condition" required>
                            <option value="">Select Condition</option>
                            <option value="New">New</option>
                            <option value="Used">Used</option>
                        </select>
                    </div>
                    <div>
                        <label for="mileage">Mileage (km)</label>
                        <input type="number" id="mileage" min="0" placeholder="e.g., 50000">
                    </div>
                    <div class="full-width">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Describe the vehicle (optional)" rows="4"></textarea>
                    </div>
                    <div>
                        <label for="imageUrl">Image URL</label>
                        <input type="url" id="imageUrl" placeholder="e.g., https://example.com/car.jpg">
                    </div>
                    <div>
                        <label for="contactUrl">Contact URL</label>
                        <input type="url" id="contactUrl" placeholder="e.g., https://wa.me/1234567890">
                    </div>
                    <div class="full-width">
                        <label><input type="checkbox" id="featured"> Mark as Featured</label>
                    </div>
                </div>
                <div id="listingPreview" style="margin-top: 1rem; background: #f9f9f9; padding: 1rem; border-radius: 8px; display: none;">
                    <h3>Listing Preview</h3>
                    <img id="previewImage" src="https://via.placeholder.com/150" alt="Preview" style="max-width: 100%; height: 150px; object-fit: cover;">
                    <p><strong id="previewTitle"></strong></p>
                    <p id="previewPrice"></p>
                    <p id="previewDetails"></p>
                </div>
                <button onclick="createListing()">Submit Listing</button>
            </div>
        </div>
        <div id="users" class="section">
            <h2>Find Users</h2>
            <div class="search-bar">
                <input type="text" id="userSearch" placeholder="Search by username">
                <button onclick="searchUsers()">Search</button>
            </div>
            <div id="userResults"></div>
            <div id="messages" style="display: none;">
                <h3>Messages with <span id="messageRecipient"></span></h3>
                <div class="message-container" id="messageContainer"></div>
                <div class="comment-form">
                    <textarea id="messageInput" placeholder="Type your message"></textarea>
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        <div id="contact" class="section">
            <h2>Contact Us</h2>
            <p>Reach out via WhatsApp: <a href="https://wa.me/2348030000000" target="_blank">+234 803 000 0000</a></p>
            <p>Email: <a href="mailto:support@themarts.com">support@themarts.com</a></p>
        </div>
    </div>
    <script>
        const API_URL = 'https://automobile-backend-dcd22d288ee3.herokuapp.com/api';
        let currentPage = 1;
        const itemsPerPage = 9;
        let vehicles = [];
        let currentRecipientId = null;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'listings') fetchVehicles();
            if (sectionId === 'home') fetchFeatured();
            if (sectionId === 'users') document.getElementById('messages').style.display = 'none';
            document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('editProfileForm').style.display = 'none';
            document.getElementById('profileInfo').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('editProfileForm').style.display = 'none';
            document.getElementById('profileInfo').style.display = 'none';
        }

        function showEditProfileForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('editProfileForm').style.display = 'block';
            document.getElementById('profileInfo').style.display = 'none';
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editBio').value = user.bio || '';
                document.getElementById('editCity').value = user.city || '';
                document.getElementById('editCountry').value = user.country || '';
                document.getElementById('editProfilePicture').value = user.profilePicture || '';
            }
        }

        function showProfileInfo() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('editProfileForm').style.display = 'none';
            document.getElementById('profileInfo').style.display = 'block';
        }

        async function register() {
            const userData = {
                username: document.getElementById('registerUsername').value,
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                bio: document.getElementById('registerBio').value,
                city: document.getElementById('registerCity').value,
                country: document.getElementById('registerCountry').value,
                profilePicture: document.getElementById('registerProfilePicture').value || 'https://via.placeholder.com/100'
            };
            try {
                const response = await fetch(`${API_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('registerSuccess').textContent = 'Profile created! Please log in.';
                    document.getElementById('registerError').textContent = '';
                    setTimeout(showLoginForm, 2000);
                } else {
                    document.getElementById('registerError').textContent = data.message || 'Registration failed';
                }
            } catch (error) {
                document.getElementById('registerError').textContent = 'Error connecting to server';
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const response = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    document.getElementById('loginSuccess').textContent = 'Login successful!';
                    document.getElementById('loginError').textContent = '';
                    updateProfile();
                } else {
                    document.getElementById('loginError').textContent = data.message || 'Login failed';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Error connecting to server';
            }
        }

        async function updateProfile() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('editProfileError').textContent = 'Please log in';
                return;
            }
            const userData = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                bio: document.getElementById('editBio').value,
                city: document.getElementById('editCity').value,
                country: document.getElementById('editCountry').value,
                profilePicture: document.getElementById('editProfilePicture').value || 'https://via.placeholder.com/100'
            };
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    document.getElementById('editProfileSuccess').textContent = 'Profile updated!';
                    document.getElementById('editProfileError').textContent = '';
                    updateProfile();
                } else {
                    document.getElementById('editProfileError').textContent = data.message || 'Update failed';
                }
            } catch (error) {
                document.getElementById('editProfileError').textContent = 'Error connecting to server';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateProfile();
            showSection('home');
        }

        function updateProfile() {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('createListingLink').style.display = user ? 'inline' : 'none';
            document.getElementById('logoutLink').style.display = user ? 'inline' : 'none';
            document.getElementById('usersLink').style.display = user ? 'inline' : 'none';
            if (user) {
                document.getElementById('authForms').style.display = 'none';
                document.getElementById('profileInfo').style.display = 'block';
                document.getElementById('profileUsername').textContent = user.username || 'User';
                document.getElementById('profileBio').textContent = user.bio || 'No bio provided';
                document.getElementById('profileLocation').textContent = (user.city || user.country) ? `${user.city || ''}${user.city && user.country ? ', ' : ''}${user.country || ''}` : 'No location provided';
                document.getElementById('profilePicture').src = user.profilePicture || 'https://via.placeholder.com/100';
            } else {
                document.getElementById('authForms').style.display = 'block';
                document.getElementById('profileInfo').style.display = 'none';
                showLoginForm();
            }
        }

        async function createListing() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('createError').textContent = 'Please log in to create a listing';
                return;
            }
            const vehicle = {
                type: document.getElementById('vehicleType').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                price: parseFloat(document.getElementById('price').value),
                origin: document.getElementById('origin').value,
                year: parseInt(document.getElementById('year').value),
                condition: document.getElementById('condition').value,
                mileage: parseInt(document.getElementById('mileage').value) || 0,
                description: document.getElementById('description').value,
                imageUrl: document.getElementById('imageUrl').value || 'https://via.placeholder.com/150',
                contactUrl: document.getElementById('contactUrl').value,
                featured: document.getElementById('featured').checked,
                verified: false
            };
            if (!vehicle.type || !vehicle.make || !vehicle.model || !vehicle.price || !vehicle.origin || !vehicle.year || !vehicle.condition) {
                document.getElementById('createError').textContent = 'Please fill all required fields';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(vehicle)
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('createSuccess').textContent = 'Listing submitted! Awaiting verification.';
                    document.getElementById('createError').textContent = '';
                    document.getElementById('create-listing').querySelector('form')?.reset();
                    document.getElementById('listingPreview').style.display = 'none';
                    fetchVehicles();
                } else {
                    document.getElementById('createError').textContent = data.message || 'Failed to create listing';
                }
            } catch (error) {
                document.getElementById('createError').textContent = 'Error connecting to server';
            }
        }

        async function fetchVehicles() {
            try {
                const token = localStorage.getItem('token');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch(`${API_URL}/vehicles`, { headers });
                vehicles = await response.json();
                filterAndSortVehicles();
            } catch (error) {
                console.error('Error fetching vehicles:', error);
                document.getElementById('listingsGrid').innerHTML = '<p>Error loading listings</p>';
            }
        }

        async function fetchFeatured() {
            try {
                const response = await fetch(`${API_URL}/vehicles?featured=true`);
                const featured = await response.json();
                displayVehicles(featured.filter(v => v.verified), 'featured');
            } catch (error) {
                console.error('Error fetching featured vehicles:', error);
            }
        }

        function filterAndSortVehicles() {
            const user = JSON.parse(localStorage.getItem('user'));
            let filtered = vehicles.filter(v => v.verified || (user && v.posterId === user._id));
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const origin = document.getElementById('originFilter').value;
            const priceSort = document.getElementById('priceSort').value;
            const yearSort = document.getElementById('yearSort').value;

            if (search) {
                filtered = filtered.filter(v => 
                    v.make.toLowerCase().includes(search) || 
                    v.model.toLowerCase().includes(search) ||
                    v.description?.toLowerCase().includes(search)
                );
            }
            if (type) filtered = filtered.filter(v => v.type === type);
            if (origin) filtered = filtered.filter(v => v.origin === origin);
            if (priceSort) {
                filtered.sort((a, b) => priceSort === 'asc' ? a.price - b.price : b.price - a.price);
            }
            if (yearSort) {
                filtered.sort((a, b) => yearSort === 'asc' ? a.year - b.year : b.year - a.year);
            }

            const start = (currentPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);
            displayVehicles(paginated, 'listingsGrid');
            updatePagination(filtered.length);
        }

        async function displayVehicles(vehicles, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (const vehicle of vehicles) {
                const comments = await fetchComments(vehicle._id);
                const likeCount = await fetchLikeCount(vehicle._id);
                const repostCount = await fetchRepostCount(vehicle._id);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${vehicle.imageUrl}" alt="${vehicle.make} ${vehicle.model}">
                    <h3>${vehicle.make} ${vehicle.model}</h3>
                    <p>Posted by: ${vehicle.posterName || 'Anonymous'}</p>
                    <p>Price: $${vehicle.price.toLocaleString()}</p>
                    <p>Type: ${vehicle.type}</p>
                    <p>Origin: ${vehicle.origin}</p>
                    <p>Year: ${vehicle.year}</p>
                    <p>Condition: ${vehicle.condition}</p>
                    ${vehicle.mileage ? `<p>Mileage: ${vehicle.mileage.toLocaleString()} km</p>` : ''}
                    ${vehicle.description ? `<p>${vehicle.description}</p>` : ''}
                    ${vehicle.contactUrl ? `<p><a href="${vehicle.contactUrl}" target="_blank">Contact Seller</a></p>` : ''}
                    <p class="${vehicle.verified ? 'status-verified' : 'status-pending'}">Status: ${vehicle.verified ? 'Verified' : 'Pending Verification'}</p>
                    <div class="social-actions">
                        <button onclick="toggleLike('${vehicle._id}')">‚ù§Ô∏è ${likeCount || 0}</button>
                        <button onclick="toggleComments('${vehicle._id}')">üí¨ ${comments.length || 0}</button>
                        <button onclick="repost('${vehicle._id}')">üîÑ ${repostCount || 0}</button>
                    </div>
                    <div class="comments-section" id="comments-${vehicle._id}" style="display: none;">
                        ${renderComments(comments)}
                        <div class="comment-form">
                            <textarea id="comment-${vehicle._id}" placeholder="Add a comment"></textarea>
                            <button onclick="postComment('${vehicle._id}')">Post</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        async function fetchLikeCount(vehicleId) {
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/likes`);
                const data = await response.json();
                return data.count || 0;
            } catch (error) {
                return 0;
            }
        }

        async function toggleLike(vehicleId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to like a vehicle');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) fetchVehicles();
                else alert('Failed to like/unlike vehicle');
            } catch (error) {
                console.error('Error liking vehicle:', error);
            }
        }

        async function fetchComments(vehicleId) {
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/comments`);
                return await response.json() || [];
            } catch (error) {
                return [];
            }
        }

        function renderComments(comments, parentId = null, level = 0) {
            let html = '';
            const filteredComments = comments.filter(c => c.parentCommentId === parentId);
            for (const comment of filteredComments) {
                html += `
                    <div class="comment ${parentId ? 'reply' : ''}" style="margin-left: ${level * 2}rem;">
                        <p><strong>${comment.author || 'Anonymous'}</strong>: ${comment.content}</p>
                        <p><small>${new Date(comment.createdAt).toLocaleString()}</small></p>
                        <button onclick="showReplyForm('${comment._id}')">Reply</button>
                        <div class="comment-form" id="reply-form-${comment._id}" style="display: none;">
                            <textarea id="reply-${comment._id}" placeholder="Reply to this comment"></textarea>
                            <button onclick="postComment('${comment.vehicleId}', '${comment._id}')">Post Reply</button>
                        </div>
                    </div>
                `;
                html += renderComments(comments, comment._id, level + 1);
            }
            return html;
        }

        function showReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function postComment(vehicleId, parentCommentId = null) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to comment');
                return;
            }
            const content = parentCommentId 
                ? document.getElementById(`reply-${parentCommentId}`).value
                : document.getElementById(`comment-${vehicleId}`).value;
            if (!content.trim()) {
                alert('Comment cannot be empty');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content, parentCommentId })
                });
                if (response.ok) {
                    fetchVehicles();
                    if (!parentCommentId) {
                        document.getElementById(`comment-${vehicleId}`).value = '';
                    } else {
                        document.getElementById(`reply-${parentCommentId}`).value = '';
                        document.getElementById(`reply-form-${parentCommentId}`).style.display = 'none';
                    }
                } else {
                    alert('Failed to post comment');
                }
            } catch (error) {
                console.error('Error posting comment:', error);
            }
        }

        function toggleComments(vehicleId) {
            const section = document.getElementById(`comments-${vehicleId}`);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function repost(vehicleId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to repost');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/repost`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) fetchVehicles();
                else alert('Failed to repost vehicle');
            } catch (error) {
                console.error('Error reposting vehicle:', error);
            }
        }

        async function fetchRepostCount(vehicleId) {
            try {
                const response = await fetch(`${API_URL}/vehicles/${vehicleId}/reposts`);
                const data = await response.json();
                return data.count || 0;
            } catch (error) {
                return 0;
            }
        }

        async function searchUsers() {
            const query = document.getElementById('userSearch').value;
            if (!query.trim()) {
                document.getElementById('userResults').innerHTML = '<p>Please enter a username</p>';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/users/search?username=${encodeURIComponent(query)}`);
                const users = await response.json();
                const results = document.getElementById('userResults');
                results.innerHTML = '';
                if (users.length === 0) {
                    results.innerHTML = '<p>No users found</p>';
                    return;
                }
                for (const user of users) {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `
                        <img src="${user.profilePicture || 'https://via.placeholder.com/50'}" alt="${user.username}">
                        <div>
                            <p><strong>${user.username}</strong></p>
                            <p>${user.bio?.substring(0, 50) || 'No bio'}...</p>
                        </div>
                        <button onclick="startMessaging('${user._id}', '${user.username}')">Message</button>
                    `;
                    results.appendChild(card);
                }
            } catch (error) {
                document.getElementById('userResults').innerHTML = '<p>Error searching users</p>';
            }
        }

        async function startMessaging(userId, username) {
            currentRecipientId = userId;
            document.getElementById('messageRecipient').textContent = username;
            document.getElementById('messages').style.display = 'block';
            document.getElementById('userResults').style.display = 'none';
            fetchMessages(userId);
        }

        async function fetchMessages(recipientId) {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('messageContainer').innerHTML = '<p>Please log in to view messages</p>';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/messages/${recipientId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const messages = await response.json();
                const container = document.getElementById('messageContainer');
                container.innerHTML = '';
                for (const msg of messages) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    const isSent = msg.senderId === user._id;
                    const div = document.createElement('div');
                    div.className = `message ${isSent ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        <p>${msg.content}</p>
                        <p><small>${new Date(msg.createdAt).toLocaleString()}</small></p>
                    `;
                    container.appendChild(div);
                }
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                document.getElementById('messageContainer').innerHTML = '<p>Error loading messages</p>';
            }
        }

        async function sendMessage() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to send messages');
                return;
            }
            const content = document.getElementById('messageInput').value;
            if (!content.trim()) {
                alert('Message cannot be empty');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ recipientId: currentRecipientId, content })
                });
                if (response.ok) {
                    document.getElementById('messageInput').value = '';
                    fetchMessages(currentRecipientId);
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            filterAndSortVehicles();
        }

        function updateListingPreview() {
            const make = document.getElementById('make').value;
            const model = document.getElementById('model').value;
            const price = document.getElementById('price').value;
            const year = document.getElementById('year').value;
            const condition = document.getElementById('condition').value;
            const imageUrl = document.getElementById('imageUrl').value;
            if (make && model) {
                document.getElementById('listingPreview').style.display = 'block';
                document.getElementById('previewImage').src = imageUrl || 'https://via.placeholder.com/150';
                document.getElementById('previewTitle').textContent = `${make} ${model}`;
                document.getElementById('previewPrice').textContent = price ? `$${parseFloat(price).toLocaleString()}` : '';
                document.getElementById('previewDetails').textContent = `${year || ''}${year && condition ? ', ' : ''}${condition || ''}`;
            } else {
                document.getElementById('listingPreview').style.display = 'none';
            }
        }

        document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; filterAndSortVehicles(); });
        document.getElementById('typeFilter').addEventListener('change', () => { currentPage = 1; filterAndSortVehicles(); });
        document.getElementById('priceSort').addEventListener('change', () => { currentPage = 1; filterAndSortVehicles(); });
        document.getElementById('originFilter').addEventListener('change', () => { currentPage = 1; filterAndSortVehicles(); });
        document.getElementById('yearSort').addEventListener('change', () => { currentPage = 1; filterAndSortVehicles(); });
        document.getElementById('make').addEventListener('input', updateListingPreview);
        document.getElementById('model').addEventListener('input', updateListingPreview);
        document.getElementById('price').addEventListener('input', updateListingPreview);
        document.getElementById('year').addEventListener('input', updateListingPreview);
        document.getElementById('condition').addEventListener('change', updateListingPreview);
        document.getElementById('imageUrl').addEventListener('input', updateListingPreview);

        updateProfile();
        showSection('home');
    </script>
</body>
</html>
