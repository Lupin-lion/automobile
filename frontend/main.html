<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheMarts - Automobile Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background-color: #f0f2f5;
        }
        nav {
            background-color: #4267B2;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        nav h1 {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        nav .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        nav .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
        }
        nav .nav-links a:hover {
            text-decoration: underline;
        }
        nav input {
            padding: 8px 12px;
            width: 300px;
            border-radius: 20px;
            border: none;
            outline: none;
            font-size: 14px;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .auth-form, .post-form, .car-post, .profile, .about, .contact, .messages, .notifications {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .auth-form form, .post-form form, .edit-profile-form, .message-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .auth-form .password-container {
            position: relative;
        }
        .auth-form .password-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .auth-form .password-container .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #4267B2;
            font-size: 12px;
        }
        .auth-form input, .post-form input, .post-form textarea, .auth-form select, .edit-profile-form input, .edit-profile-form textarea, .message-form input, .message-form textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .auth-form button, .post-form button, .create-post-btn, .back-btn, .edit-profile-btn, .save-profile-btn, .message-form button, .connect-btn {
            padding: 10px;
            background-color: #4267B2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .auth-form button:hover, .post-form button:hover, .create-post-btn:hover, .back-btn:hover, .edit-profile-btn:hover, .save-profile-btn:hover, .message-form button:hover, .connect-btn:hover {
            background-color: #365899;
        }
        .car-post {
            position: relative;
            border-bottom: 1px solid #dddfe2;
            padding-bottom: 15px;
        }
        .car-post img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 10px;
        }
        .car-post h3 {
            margin: 10px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1c1e21;
        }
        .car-post p {
            color: #606770;
            font-size: 14px;
            line-height: 1.4;
        }
        .car-post .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .car-post .post-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }
        .car-post .post-header .username {
            font-size: 14px;
            font-weight: 600;
            color: #4267B2;
            cursor: pointer;
        }
        .car-post .follow-btn {
            background-color: #4267B2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-left: auto;
        }
        .car-post .follow-btn.following {
            background-color: #e4e6eb;
            color: #1c1e21;
        }
        .car-post .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #dddfe2;
            padding-top: 10px;
        }
        .car-post .actions button {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            color: #606770;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .car-post .actions button:hover {
            background-color: #f0f2f5;
            border-radius: 4px;
        }
        .car-post .like-btn.liked {
            color: #4267B2;
        }
        .comments {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dddfe2;
        }
        .comments input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
        }
        .comments .comment {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }
        .comments .comment img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .comments .comment div {
            background: #f0f2f5;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            color: #1c1e21;
        }
        .comments .comment div strong {
            font-weight: 600;
        }
        .profile {
            text-align: left;
        }
        .profile .cover-photo {
            width: 100%;
            height: 200px;
            background: #ddd;
            border-radius: 8px 8px 0 0;
        }
        .profile .profile-header {
            position: relative;
            margin-top: -60px;
            padding: 0 20px;
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }
        .profile .profile-header img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
        }
        .profile .profile-header .info {
            flex: 1;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .profile .profile-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1c1e21;
        }
        .profile .profile-header .follow-btn, .connect-btn {
            background-color: #4267B2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .profile .profile-header .follow-btn.following {
            background-color: #e4e6eb;
            color: #1c1e21;
        }
        .profile .profile-details {
            padding: 20px;
            border-top: 1px solid #dddfe2;
        }
        .profile .profile-details p {
            margin: 8px 0;
            font-size: 14px;
            color: #1c1e21;
        }
        .profile .profile-details p strong {
            color: #606770;
        }
        .profile .followers-list {
            margin-top: 20px;
        }
        .profile .followers-list h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1c1e21;
            margin-bottom: 10px;
        }
        .profile .followers-list .follower {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .profile .followers-list .follower:hover {
            background-color: #f0f2f5;
        }
        .profile .followers-list .follower img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile .followers-list .follower span {
            font-size: 14px;
            font-weight: 500;
            color: #1c1e21;
        }
        .search-results {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .search-results .user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #dddfe2;
            cursor: pointer;
        }
        .search-results .user:last-child {
            border-bottom: none;
        }
        .search-results .user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .search-results .user span {
            font-size: 14px;
            font-weight: 500;
            color: #1c1e21;
        }
        .about, .contact {
            line-height: 1.6;
            font-size: 14px;
            color: #1c1e21;
        }
        .contact a {
            color: #4267B2;
            text-decoration: none;
        }
        #error {
            color: #d32f2f;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .create-post-btn {
            margin-bottom: 20px;
            display: block;
            width: 100%;
            text-align: center;
            background-color: #f0f2f5;
            color: #1c1e21;
            font-weight: 500;
        }
        .create-post-btn:hover {
            background-color: #e4e6eb;
        }
        .back-btn {
            margin-bottom: 10px;
            display: block;
            background-color: #e4e6eb;
            color: #1c1e21;
            font-weight: 500;
        }
        .back-btn:hover {
            background-color: #dadde1;
        }
        .edit-profile-form {
            display: none;
        }
        .edit-profile-form.active {
            display: flex;
        }
        .messages .message-thread {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .messages .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        .messages .message img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .messages .message div {
            background: #f0f2f5;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            color: #1c1e21;
        }
        .messages .message.sent div {
            background: #4267B2;
            color: white;
        }
        .notifications .notification {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #dddfe2;
            cursor: pointer;
        }
        .notifications .notification:last-child {
            border-bottom: none;
        }
        .notifications .notification.unread {
            background-color: #e7f3ff;
        }
        .notifications .notification img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .notifications .notification span {
            font-size: 14px;
            color: #1c1e21;
        }
        .notification-count {
            background: #d32f2f;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            position: relative;
            top: -10px;
            left: -5px;
        }
    </style>
</head>
<body>
    <nav>
        <h1 onclick="showSection('homeSection')">TheMarts</h1>
        <input type="text" id="searchBar" placeholder="Search users or cars...">
        <div class="nav-links">
            <a href="#" onclick="showSection('profileSection')">Profile</a>
            <a href="#" onclick="showSection('messagesSection')">Messages</a>
            <a href="#" onclick="showSection('notificationsSection')">Notifications <span id="notificationCount" class="notification-count" style="display: none;"></span></a>
            <a href="#" onclick="showSection('aboutSection')">About</a>
            <a href="#" onclick="showSection('contactSection')">Contact</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- Error Section -->
        <div id="error"></div>

        <!-- Login Section -->
        <div id="loginSection" class="section active">
            <div class="auth-form">
                <h2>Login</h2>
                <form id="loginForm">
                    <input type="text" id="loginPhoneNumber" placeholder="Phone Number" required>
                    <div class="password-container">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePassword('loginPassword')">Show</span>
                    </div>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showSection('registerSection')">Register</a></p>
            </div>
        </div>

        <!-- Register Section -->
        <div id="registerSection" class="section">
            <div class="auth-form">
                <button class="back-btn" onclick="showSection('loginSection')">Back</button>
                <h2>Register</h2>
                <form id="registerForm">
                    <input type="text" id="regFirstName" placeholder="First Name" required>
                    <input type="text" id="regLastName" placeholder="Last Name" required>
                    <input type="text" id="regPhoneNumber" placeholder="Phone Number (e.g., +1234567890)" required>
                    <div class="password-container">
                        <input type="password" id="regPassword" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePassword('regPassword')">Show</span>
                    </div>
                    <input type="date" id="regDob" required>
                    <select id="regGender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showSection('loginSection')">Login</a></p>
            </div>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section">
            <div class="search-results" id="searchResults" style="display: none;"></div>
            <button class="create-post-btn" onclick="showSection('createPostSection')">Create Post</button>
            <div id="carListings"></div>
        </div>

        <!-- Create Post Section -->
        <div id="createPostSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="post-form">
                <h2>Post a Car for Sale</h2>
                <form id="carForm" enctype="multipart/form-data">
                    <input type="text" id="carTitle" placeholder="Car Title (e.g., 2019 Toyota Camry)" required>
                    <input type="text" id="carPrice" placeholder="Price (e.g., $15,000)" required>
                    <textarea id="carDescription" placeholder="Description (e.g., mileage, condition)" required></textarea>
                    <input type="file" id="carImage" accept="image/*" required>
                    <button type="submit">Post Car</button>
                </form>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="profile" id="userProfile">
                <div class="cover-photo"></div>
                <div class="profile-header">
                    <img id="profilePicture" src="" alt="">
                    <div class="info">
                        <h2 id="profileUsername"></h2>
                        <button class="edit-profile-btn" onclick="showEditProfileForm()">Edit Profile</button>
                    </div>
                </div>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span id="profileName"></span></p>
                    <p><strong>Gender:</strong> <span id="profileGender"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="profileDob"></span></p>
                    <p><strong>Bio:</strong> <span id="profileBio"></span></p>
                    <p><strong>Followers:</strong> <span id="profileFollowersCount"></span></p>
                    <div class="followers-list" id="followersList"></div>
                </div>
                <div class="edit-profile-form" id="editProfileForm">
                    <h3>Edit Profile</h3>
                    <form id="editProfileFormSubmit" enctype="multipart/form-data">
                        <textarea id="editBio" placeholder="Update your bio"></textarea>
                        <input type="file" id="editProfilePicture" accept="image/*">
                        <button type="submit" class="save-profile-btn">Save</button>
                        <button type="button" class="back-btn" onclick="hideEditProfileForm()">Cancel</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Other User's Profile Section -->
        <div id="otherProfileSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="profile" id="otherUserProfile">
                <div class="cover-photo"></div>
                <div class="profile-header">
                    <img id="otherProfilePicture" src="" alt="">
                    <div class="info">
                        <h2 id="otherProfileUsername"></h2>
                        <button class="follow-btn" id="otherProfileFollowBtn"></button>
                        <button class="connect-btn" id="connectBtn">Message</button>
                    </div>
                </div>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span id="otherProfileName"></span></p>
                    <p><strong>Gender:</strong> <span id="otherProfileGender"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="otherProfileDob"></span></p>
                    <p><strong>Bio:</strong> <span id="otherProfileBio"></span></p>
                    <p><strong>Followers:</strong> <span id="otherProfileFollowersCount"></span></p>
                    <div class="followers-list" id="otherFollowersList"></div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div id="messagesSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="messages">
                <h2>Messages</h2>
                <div id="messageThreads"></div>
                <div class="message-form">
                    <h3>Start a Conversation</h3>
                    <form id="messageForm">
                        <input type="text" id="messageReceiver" placeholder="Receiver's Username" required>
                        <textarea id="messageContent" placeholder="Type your message..." required></textarea>
                        <button type="submit">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="notificationsSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="notifications">
                <h2>Notifications</h2>
                <div id="notificationList"></div>
            </div>
        </div>

        <!-- About Section -->
        <div id="aboutSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="about">
                <h2>About TheMarts</h2>
                <p>TheMarts is a dedicated marketplace for automobile enthusiasts to buy, sell, and connect over their passion for cars. Our platform allows users to post their cars for sale, browse listings, comment, like, and follow other users. We focus exclusively on automobiles, ensuring a clutter-free experience with only car-related content.</p>
                <p>Founded in 2025, TheMarts aims to create a community where car lovers can share their vehicles and stories safely and easily. Join us today!</p>
            </div>
        </div>

        <!-- Contact Section -->
        <div id="contactSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back</button>
            <div class="contact">
                <h2>Contact TheMarts Officials</h2>
                <p>If you have any questions, feedback, or need support, feel free to reach out to us:</p>
                <p>Email: <a href="mailto:support@themarts.com">support@themarts.com</a></p>
                <p>Phone: +1 (555) 123-4567</p>
                <p>Address: 123 Auto Lane, Car City, CA 90210</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://themartsbackend-b1ad232b40bb.herokuapp.com';
        let currentUser = null;
        let currentChatUserId = null;

        // Helper functions
        function showSection(sectionId, userId = null) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('error').textContent = '';
            document.getElementById('searchBar').value = '';

            if (sectionId === 'homeSection') {
                fetchPosts();
                fetchNotifications();
            } else if (sectionId === 'profileSection') {
                fetchUserProfile();
            } else if (sectionId === 'otherProfileSection' && userId) {
                fetchUserProfile(userId);
            } else if (sectionId === 'messagesSection') {
                fetchMessageThreads();
            } else if (sectionId === 'notificationsSection') {
                fetchNotifications(true);
            }
        }

        function displayError(message) {
            document.getElementById('error').textContent = message;
        }

        function clearError() {
            document.getElementById('error').textContent = '';
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleText = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggleText.textContent = 'Hide';
            } else {
                input.type = 'password';
                toggleText.textContent = 'Show';
            }
        }

        // Show/hide edit profile form
        function showEditProfileForm() {
            document.getElementById('editProfileForm').classList.add('active');
            document.querySelector('.profile-details').style.display = 'none';
            document.querySelector('.edit-profile-btn').style.display = 'none';
        }

        function hideEditProfileForm() {
            document.getElementById('editProfileForm').classList.remove('active');
            document.querySelector('.profile-details').style.display = 'block';
            document.querySelector('.edit-profile-btn').style.display = 'block';
            fetchUserProfile();
        }

        // Initialize the app: Check for token and fetch user profile
        (async function initializeApp() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const user = await response.json();
                    if (response.ok) {
                        currentUser = user;
                        showSection('homeSection');
                        fetchNotifications();
                    } else {
                        localStorage.removeItem('token');
                        showSection('loginSection');
                    }
                } catch (error) {
                    console.error('Failed to fetch user profile:', error);
                    localStorage.removeItem('token');
                    showSection('loginSection');
                }
            } else {
                showSection('loginSection');
            }
        })();

        // Handle Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const phoneNumber = document.getElementById('loginPhoneNumber').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber, password })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                localStorage.setItem('token', data.token);
                currentUser = data.user;
                showSection('homeSection');
                fetchPosts();
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const phoneNumber = document.getElementById('regPhoneNumber').value;
            const password = document.getElementById('regPassword').value;
            const dob = document.getElementById('regDob').value;
            const gender = document.getElementById('regGender').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phoneNumber,
                        password,
                        dob,
                        gender
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                localStorage.setItem('token', data.token);
                currentUser = data.user;
                showSection('homeSection');
                fetchPosts();
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            showSection('loginSection');
        }

        // Fetch user profile
        async function fetchUserProfile(userId = null) {
            try {
                const url = userId ? `${API_BASE_URL}/api/users/${userId}` : `${API_BASE_URL}/api/users/profile`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const user = await response.json();
                if (!response.ok) {
                    throw new Error(user.error || 'Failed to fetch profile');
                }

                const profileDiv = userId ? document.getElementById('otherUserProfile') : document.getElementById('userProfile');
                const isFollowing = user.followers.includes(currentUser?._id || '');

                if (userId) {
                    document.getElementById('otherProfilePicture').src = user.profilePicture;
                    document.getElementById('otherProfileUsername').textContent = user.username;
                    document.getElementById('otherProfileName').textContent = `${user.firstName} ${user.lastName}`;
                    document.getElementById('otherProfileGender').textContent = user.gender;
                    document.getElementById('otherProfileDob').textContent = new Date(user.dob).toLocaleDateString();
                    document.getElementById('otherProfileBio').textContent = user.bio || 'Not set';
                    document.getElementById('otherProfileFollowersCount').textContent = user.followers.length;

                    const followBtn = document.getElementById('otherProfileFollowBtn');
                    followBtn.textContent = isFollowing ? 'Following' : 'Follow';
                    followBtn.className = `follow-btn ${isFollowing ? 'following' : ''}`;
                    followBtn.dataset.user = user._id;

                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.dataset.user = user._id;
                    connectBtn.addEventListener('click', () => {
                        currentChatUserId = user._id;
                        showSection('messagesSection');
                        fetchMessages(user._id);
                    });

                    // Fetch followers
                    const followersList = document.getElementById('otherFollowersList');
                    followersList.innerHTML = '<h3>Followers</h3>';
                    for (const followerId of user.followers) {
                        const follower = await (await fetch(`${API_BASE_URL}/api/users/${followerId}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })).json();
                        const followerDiv = document.createElement('div');
                        followerDiv.classList.add('follower');
                        followerDiv.dataset.user = follower._id;
                        followerDiv.innerHTML = `
                            <img src="${follower.profilePicture}" alt="${follower.username}">
                            <span>${follower.username}</span>
                        `;
                        followerDiv.addEventListener('click', () => {
                            showSection('otherProfileSection', follower._id);
                        });
                        followersList.appendChild(followerDiv);
                    }
                } else {
                    document.getElementById('profilePicture').src = user.profilePicture;
                    document.getElementById('profileUsername').textContent = user.username;
                    document.getElementById('profileName').textContent = `${user.firstName} ${user.lastName}`;
                    document.getElementById('profileGender').textContent = user.gender;
                    document.getElementById('profileDob').textContent = new Date(user.dob).toLocaleDateString();
                    document.getElementById('profileBio').textContent = user.bio || 'Not set';
                    document.getElementById('profileFollowersCount').textContent = user.followers.length;

                    // Fetch followers
                    const followersList = document.getElementById('followersList');
                    followersList.innerHTML = '<h3>Followers</h3>';
                    for (const followerId of user.followers) {
                        const follower = await (await fetch(`${API_BASE_URL}/api/users/${followerId}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })).json();
                        const followerDiv = document.createElement('div');
                        followerDiv.classList.add('follower');
                        followerDiv.dataset.user = follower._id;
                        followerDiv.innerHTML = `
                            <img src="${follower.profilePicture}" alt="${follower.username}">
                            <span>${follower.username}</span>
                        `;
                        followerDiv.addEventListener('click', () => {
                            showSection('otherProfileSection', follower._id);
                        });
                        followersList.appendChild(followerDiv);
                    }
                }
            } catch (error) {
                displayError(error.message);
            }
        }

        // Handle profile update
        document.getElementById('editProfileFormSubmit').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const bio = document.getElementById('editBio').value;
            const profilePicture = document.getElementById('editProfilePicture').files[0];

            const formData = new FormData();
            if (bio) formData.append('bio', bio);
            if (profilePicture) formData.append('profilePicture', profilePicture);

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const user = await response.json();
                if (!response.ok) {
                    throw new Error(user.error || 'Failed to update profile');
                }

                currentUser = user;
                hideEditProfileForm();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Fetch posts
        async function fetchPosts(searchTerm = '') {
            try {
                const url = searchTerm ? `${API_BASE_URL}/api/posts/search/${searchTerm}` : `${API_BASE_URL}/api/posts`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const posts = await response.json();
                if (!response.ok) {
                    throw new Error(posts.error || 'Failed to fetch posts');
                }

                displayPosts(posts);
            } catch (error) {
                displayError(error.message);
            }
        }

        // Display posts
        async function displayPosts(posts) {
            const listingsDiv = document.getElementById('carListings');
            listingsDiv.innerHTML = '';

            for (const post of posts) {
                const user = post.user;
                const hasLiked = currentUser ? post.likes.includes(currentUser._id) : false;
                const carDiv = document.createElement('div');
                carDiv.classList.add('car-post');
                carDiv.innerHTML = `
                    <div class="post-header">
                        <img src="${user.profilePicture}" alt="${user.username}" data-user="${user._id}">
                        <span class="username" data-user="${user._id}">${user.username}</span>
                        <button class="follow-btn ${currentUser && currentUser.following && currentUser.following.includes(user._id) ? 'following' : ''}" data-user="${user._id}">
                            ${currentUser && currentUser.following && currentUser.following.includes(user._id) ? 'Following' : 'Follow'}
                        </button>
                    </div>
                    <h3>${post.title}</h3>
                    <p><strong>Price:</strong> ${post.price}</p>
                    <p>${post.description}</p>
                    <img src="${post.image}" alt="${post.title}">
                    <div class="actions">
                        <button class="like-btn ${hasLiked ? 'liked' : ''}" data-id="${post._id}">
                            Like (${post.likes.length})
                        </button>
                        <button class="comment-btn" data-id="${post._id}">Comment (${post.comments.length})</button>
                    </div>
                    <div class="comments" id="comments-${post._id}" style="display: none;"></div>
                `;

                listingsDiv.appendChild(carDiv);

                const commentsDiv = document.getElementById(`comments-${post._id}`);
                for (const comment of post.comments) {
                    const commenter = await (await fetch(`${API_BASE_URL}/api/users/${comment.user}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    })).json();
                    const commentDiv = document.createElement('div');
                    commentDiv.classList.add('comment');
                    commentDiv.innerHTML = `
                        <img src="${commenter.profilePicture}" alt="${comment.username}">
                        <div>
                            <strong>${comment.username}</strong>
                            <p>${comment.text}</p>
                        </div>
                    `;
                    commentsDiv.appendChild(commentDiv);
                }

                const commentInput = document.createElement('input');
                commentInput.type = 'text';
                commentInput.className = 'comment-input';
                commentInput.placeholder = 'Write a comment...';
                commentInput.dataset.id = post._id;
                commentsDiv.appendChild(commentInput);
            }

            // Attach event listeners using delegation
            attachEventListeners();
        }

        // Attach event listeners using delegation
        function attachEventListeners() {
            // Like buttons
            document.getElementById('carListings').addEventListener('click', async (e) => {
                if (e.target.classList.contains('like-btn')) {
                    const postId = e.target.dataset.id;
                    await handleLike(postId);
                }
            });

            // Comment buttons
            document.getElementById('carListings').addEventListener('click', (e) => {
                if (e.target.classList.contains('comment-btn')) {
                    const postId = e.target.dataset.id;
                    toggleComments(postId);
                }
            });

            // Comment inputs
            document.getElementById('carListings').addEventListener('keypress', async (e) => {
                if (e.target.classList.contains('comment-input') && e.key === 'Enter') {
                    const postId = e.target.dataset.id;
                    await handleComment(postId, e.target);
                }
            });

            // Follow buttons
            document.getElementById('carListings').addEventListener('click', async (e) => {
                if (e.target.classList.contains('follow-btn')) {
                    const userId = e.target.dataset.user;
                    await handleFollow(userId);
                }
            });

            // Profile navigation
            document.getElementById('carListings').addEventListener('click', (e) => {
                if (e.target.classList.contains('username') || (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('post-header'))) {
                    const userId = e.target.dataset.user;
                    showSection('otherProfileSection', userId);
                }
            });

            // Follow button in other profile
            const otherProfileFollowBtn = document.getElementById('otherProfileFollowBtn');
            if (otherProfileFollowBtn) {
                otherProfileFollowBtn.onclick = async () => {
                    const userId = otherProfileFollowBtn.dataset.user;
                    await handleFollow(userId);
                };
            }
        }

        // Handle post creation
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const title = document.getElementById('carTitle').value;
            const price = document.getElementById('carPrice').value;
            const description = document.getElementById('carDescription').value;
            const image = document.getElementById('carImage').files[0];

            const formData = new FormData();
            formData.append('title', title);
            formData.append('price', price);
            formData.append('description', description);
            if (image) {
                formData.append('image', image);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to create post');
                }

                showSection('homeSection');
                fetchPosts();
                e.target.reset();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle liking a post
        async function handleLike(postId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to like post');
                }

                fetchPosts();
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        }

        // Toggle comments section
        function toggleComments(postId) {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Handle commenting
        async function handleComment(postId, input) {
            const text = input.value.trim();
            if (!text) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ text })
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to comment');
                }

                input.value = '';
                fetchPosts();
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        }

        // Handle following a user
        async function handleFollow(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/follow`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to follow/unfollow');
                }

                // Refresh current user data
                const userResponse = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                currentUser = await userResponse.json();

                // Refresh the current view
                if (document.getElementById('homeSection').classList.contains('active')) {
                    fetchPosts();
                } else if (document.getElementById('profileSection').classList.contains('active')) {
                    fetchUserProfile();
                } else if (document.getElementById('otherProfileSection').classList.contains('active')) {
                    fetchUserProfile(userId);
                }
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        }

        // Search functionality
        document.getElementById('searchBar').addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.includes('about')) {
                showSection('aboutSection');
                return;
            }
            if (query.includes('contact')) {
                showSection('contactSection');
                return;
            }

            if (!query) {
                document.getElementById('searchResults').style.display = 'none';
                fetchPosts();
                return;
            }

            // Search users
            try {
                const userResponse = await fetch(`${API_BASE_URL}/api/users/search/${query}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const users = await userResponse.json();

                const searchResults = document.getElementById('searchResults');
                searchResults.style.display = 'block';
                searchResults.innerHTML = users.map(user => `
                    <div class="user" data-user="${user._id}">
                        <img src="${user.profilePicture}" alt="${user.username}">
                        <span>${user.username}</span>
                    </div>
                `).join('');

                document.querySelectorAll('.user').forEach(userDiv => {
                    userDiv.addEventListener('click', () => {
                        showSection('otherProfileSection', userDiv.dataset.user);
                    });
                });

                // Search posts
                fetchPosts(query);
            } catch (error) {
                displayError(error.message);
            }
        });

        // Fetch message threads
        async function fetchMessageThreads() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/search/`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const users = await response.json();

                const threads = new Map();
                for (const user of users) {
                    if (user._id === currentUser._id) continue;
                    const messages = await (await fetch(`${API_BASE_URL}/api/messages/${user._id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    })).json();
                    if (messages.length > 0) {
                        threads.set(user._id, { user, lastMessage: messages[messages.length - 1] });
                    }
                }

                const threadsDiv = document.getElementById('messageThreads');
                threadsDiv.innerHTML = '';
                for (const [userId, thread] of threads) {
                    const threadDiv = document.createElement('div');
                    threadDiv.classList.add('user');
                    threadDiv.dataset.user = userId;
                    threadDiv.innerHTML = `
                        <img src="${thread.user.profilePicture}" alt="${thread.user.username}">
                        <span>${thread.user.username}: ${thread.lastMessage.content}</span>
                    `;
                    threadDiv.addEventListener('click', () => {
                        currentChatUserId = userId;
                        fetchMessages(userId);
                    });
                    threadsDiv.appendChild(threadDiv);
                }

                if (currentChatUserId) {
                    fetchMessages(currentChatUserId);
                }
            } catch (error) {
                displayError(error.message);
            }
        }

        // Fetch messages
        async function fetchMessages(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/messages/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const messages = await response.json();

                const threadsDiv = document.getElementById('messageThreads');
                threadsDiv.innerHTML = `<h3>Conversation with ${messages[0]?.receiver._id === userId ? messages[0].receiver.username : messages[0].sender.username}</h3>`;
                const messageThread = document.createElement('div');
                messageThread.classList.add('message-thread');
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', message.sender._id === currentUser._id ? 'sent' : 'received');
                    messageDiv.innerHTML = `
                        <img src="${message.sender.profilePicture}" alt="${message.sender.username}">
                        <div>
                            <strong>${message.sender.username}</strong>
                            <p>${message.content}</p>
                        </div>
                    `;
                    messageThread.appendChild(messageDiv);
                });
                threadsDiv.appendChild(messageThread);

                const messageForm = document.querySelector('.message-form');
                messageForm.style.display = 'block';
                document.getElementById('messageReceiver').value = messages[0]?.receiver._id === userId ? messages[0].receiver.username : messages[0].sender.username;
            } catch (error) {
                displayError(error.message);
            }
        }

        // Handle sending a message
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const receiverUsername = document.getElementById('messageReceiver').value;
            const content = document.getElementById('messageContent').value;

            try {
                const userResponse = await fetch(`${API_BASE_URL}/api/users/search/${receiverUsername}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const users = await userResponse.json();
                const receiver = users.find(user => user.username === receiverUsername);
                if (!receiver) {
                    throw new Error('User not found');
                }

                const response = await fetch(`${API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ receiver: receiver._id, content })
                });

                const message = await response.json();
                if (!response.ok) {
                    throw new Error(message.error || 'Failed to send message');
                }

                currentChatUserId = receiver._id;
                fetchMessages(receiver._id);
                e.target.reset();
                fetchNotifications();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Fetch notifications
        async function fetchNotifications(showToSection = false) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const notifications = await response.json();

                const unreadCount = notifications.filter(n => !n.read).length;
                const countSpan = document.getElementById('notificationCount');
                countSpan.textContent = unreadCount;
                countSpan.style.display = unreadCount > 0 ? 'inline' : 'none';

                if (showToSection) {
                    const notificationList = document.getElementById('notificationList');
                    notificationList.innerHTML = '';
                    for (const notification of notifications) {
                        let message = '';
                        if (notification.type === 'like') {
                            message = `${notification.fromUser.username} liked your post "${notification.post.title}"`;
                        } else if (notification.type === 'comment') {
                            message = `${notification.fromUser.username} commented on your post
