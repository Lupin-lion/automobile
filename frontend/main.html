<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheMarts - Automobile Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f0f2f5;
        }
        nav {
            background-color: #1877f2;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        nav h1 {
            font-size: 24px;
            cursor: pointer;
        }
        nav .nav-links {
            display: flex;
            gap: 20px;
        }
        nav .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 16px;
        }
        nav .nav-links a:hover {
            text-decoration: underline;
        }
        nav input {
            padding: 8px;
            width: 300px;
            border-radius: 20px;
            border: none;
            outline: none;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .auth-form, .post-form, .car-post, .profile, .about, .contact {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .auth-form form, .post-form form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .auth-form input, .post-form input, .post-form textarea, .auth-form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .auth-form button, .post-form button {
            padding: 10px;
            background-color: #1877f2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .auth-form button:hover, .post-form button:hover {
            background-color: #145db2;
        }
        .car-post {
            position: relative;
        }
        .car-post img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }
        .car-post h3 {
            margin: 10px 0;
        }
        .car-post p {
            color: #333;
        }
        .car-post .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .car-post .actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .car-post .like-btn {
            background-color: #e4e6eb;
        }
        .car-post .like-btn.liked {
            background-color: #1877f2;
            color: white;
        }
        .car-post .comment-btn {
            background-color: #e4e6eb;
        }
        .car-post .follow-btn {
            background-color: #42b72a;
            color: white;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .car-post .follow-btn.following {
            background-color: #e4e6eb;
            color: black;
        }
        .car-post .username {
            cursor: pointer;
            color: #1877f2;
        }
        .comments {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        .comments input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .comments .comment {
            background: #f0f2f5;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .profile {
            text-align: center;
        }
        .profile img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .profile .follow-btn {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #42b72a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .profile .follow-btn.following {
            background-color: #e4e6eb;
            color: black;
        }
        .search-results {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-results .user {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .search-results .user:last-child {
            border-bottom: none;
        }
        .about, .contact {
            line-height: 1.6;
        }
        .contact a {
            color: #1877f2;
            text-decoration: none;
        }
        #error {
            color: red;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav>
        <h1 onclick="showSection('homeSection')">TheMarts</h1>
        <input type="text" id="searchBar" placeholder="Search users or cars...">
        <div class="nav-links">
            <a href="#" onclick="showSection('profileSection')">Profile</a>
            <a href="#" onclick="showSection('aboutSection')">About</a>
            <a href="#" onclick="showSection('contactSection')">Contact</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- Error Section -->
        <div id="error"></div>

        <!-- Login Section -->
        <div id="loginSection" class="section active">
            <div class="auth-form">
                <h2>Login</h2>
                <form id="loginForm">
                    <input type="text" id="loginPhoneNumber" placeholder="Phone Number" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showSection('registerSection')">Register</a></p>
            </div>
        </div>

        <!-- Register Section -->
        <div id="registerSection" class="section">
            <div class="auth-form">
                <h2>Register</h2>
                <form id="registerForm">
                    <input type="text" id="regFirstName" placeholder="First Name" required>
                    <input type="text" id="regLastName" placeholder="Last Name" required>
                    <input type="text" id="regPhoneNumber" placeholder="Phone Number (e.g., +1234567890)" required>
                    <input type="password" id="regPassword" placeholder="Password" required>
                    <input type="date" id="regDob" required>
                    <select id="regGender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showSection('loginSection')">Login</a></p>
            </div>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section">
            <div class="search-results" id="searchResults" style="display: none;"></div>
            <div class="post-form">
                <h2>Post a Car for Sale</h2>
                <form id="carForm">
                    <input type="text" id="carTitle" placeholder="Car Title (e.g., 2019 Toyota Camry)" required>
                    <input type="text" id="carPrice" placeholder="Price (e.g., $15,000)" required>
                    <textarea id="carDescription" placeholder="Description (e.g., mileage, condition)" required></textarea>
                    <input type="text" id="carImage" placeholder="Image URL (e.g., https://via.placeholder.com/300)" required>
                    <button type="submit">Post Car</button>
                </form>
            </div>
            <div id="carListings"></div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section">
            <div class="profile" id="userProfile"></div>
        </div>

        <!-- Other User's Profile Section -->
        <div id="otherProfileSection" class="section">
            <div class="profile" id="otherUserProfile"></div>
        </div>

        <!-- About Section -->
        <div id="aboutSection" class="section">
            <div class="about">
                <h2>About TheMarts</h2>
                <p>TheMarts is a dedicated marketplace for automobile enthusiasts to buy, sell, and connect over their passion for cars. Our platform allows users to post their cars for sale, browse listings, comment, like, and follow other users. We focus exclusively on automobiles, ensuring a clutter-free experience with only car-related content.</p>
                <p>Founded in 2025, TheMarts aims to create a community where car lovers can share their vehicles and stories safely and easily. Join us today!</p>
            </div>
        </div>

        <!-- Contact Section -->
        <div id="contactSection" class="section">
            <div class="contact">
                <h2>Contact TheMarts Officials</h2>
                <p>If you have any questions, feedback, or need support, feel free to reach out to us:</p>
                <p>Email: <a href="mailto:support@themarts.com">support@themarts.com</a></p>
                <p>Phone: +1 (555) 123-4567</p>
                <p>Address: 123 Auto Lane, Car City, CA 90210</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://themartsbackend-b1ad232b40bb.herokuapp.com';
        let currentUser = null;

        // Helper functions
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('error').textContent = '';
            document.getElementById('searchBar').value = '';

            if (sectionId === 'homeSection') {
                fetchPosts();
            } else if (sectionId === 'profileSection') {
                fetchUserProfile();
            }
        }

        function displayError(message) {
            document.getElementById('error').textContent = message;
        }

        function clearError() {
            document.getElementById('error').textContent = '';
        }

        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (token) {
            showSection('homeSection');
        } else {
            showSection('loginSection');
        }

        // Handle Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const phoneNumber = document.getElementById('loginPhoneNumber').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber, password })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                localStorage.setItem('token', data.token);
                currentUser = data.user;
                showSection('homeSection');
                fetchPosts();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const phoneNumber = document.getElementById('regPhoneNumber').value;
            const password = document.getElementById('regPassword').value;
            const dob = document.getElementById('regDob').value;
            const gender = document.getElementById('regGender').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phoneNumber,
                        password,
                        dob,
                        gender
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                localStorage.setItem('token', data.token);
                currentUser = data.user;
                showSection('homeSection');
                fetchPosts();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            showSection('loginSection');
        }

        // Fetch user profile
        async function fetchUserProfile(userId = null) {
            try {
                const url = userId ? `${API_BASE_URL}/api/users/${userId}` : `${API_BASE_URL}/api/users/profile`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const user = await response.json();
                if (!response.ok) {
                    throw new Error(user.error || 'Failed to fetch profile');
                }

                const profileDiv = userId ? document.getElementById('otherUserProfile') : document.getElementById('userProfile');
                const isFollowing = user.followers.includes(currentUser._id);
                profileDiv.innerHTML = `
                    <img src="${user.profilePicture}" alt="${user.username}">
                    <h2>${user.username}</h2>
                    <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                    <p><strong>Gender:</strong> ${user.gender}</p>
                    <p><strong>Date of Birth:</strong> ${new Date(user.dob).toLocaleDateString()}</p>
                    <p><strong>Bio:</strong> ${user.bio || 'Not set'}</p>
                    <p><strong>Followers:</strong> ${user.followers.length}</p>
                    ${userId && userId !== currentUser._id ? `
                        <button class="follow-btn ${isFollowing ? 'following' : ''}" data-user="${user._id}">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>
                    ` : ''}
                `;

                if (userId && userId !== currentUser._id) {
                    document.querySelector('.follow-btn').addEventListener('click', handleFollow);
                }
            } catch (error) {
                displayError(error.message);
            }
        }

        // Fetch posts
        async function fetchPosts(searchTerm = '') {
            try {
                const url = searchTerm ? `${API_BASE_URL}/api/posts/search/${searchTerm}` : `${API_BASE_URL}/api/posts`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const posts = await response.json();
                if (!response.ok) {
                    throw new Error(posts.error || 'Failed to fetch posts');
                }

                displayPosts(posts);
            } catch (error) {
                displayError(error.message);
            }
        }

        // Display posts
        function displayPosts(posts) {
            const listingsDiv = document.getElementById('carListings');
            listingsDiv.innerHTML = '';

            posts.forEach(post => {
                const hasLiked = post.likes.includes(currentUser._id);
                const carDiv = document.createElement('div');
                carDiv.classList.add('car-post');
                carDiv.innerHTML = `
                    <h3>${post.title}</h3>
                    <p><strong>Price:</strong> ${post.price}</p>
                    <img src="${post.image}" alt="${post.title}">
                    <p>${post.description}</p>
                    <p><strong>Posted by:</strong> <span class="username" data-user="${post.user._id}">${post.user.username}</span></p>
                    <button class="follow-btn ${currentUser.following && currentUser.following.includes(post.user._id) ? 'following' : ''}" data-user="${post.user._id}">
                        ${currentUser.following && currentUser.following.includes(post.user._id) ? 'Following' : 'Follow'}
                    </button>
                    <div class="actions">
                        <button class="like-btn ${hasLiked ? 'liked' : ''}" data-id="${post._id}">
                            Like (${post.likes.length})
                        </button>
                        <button class="comment-btn" data-id="${post._id}">Comment</button>
                    </div>
                    <div class="comments" id="comments-${post._id}" style="display: none;">
                        <input type="text" class="comment-input" placeholder="Write a comment..." data-id="${post._id}">
                        <div class="comment-list" id="comment-list-${post._id}"></div>
                    </div>
                `;

                listingsDiv.appendChild(carDiv);

                const commentList = document.getElementById(`comment-list-${post._id}`);
                post.comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.classList.add('comment');
                    commentDiv.textContent = `${comment.username}: ${comment.text}`;
                    commentList.appendChild(commentDiv);
                });
            });

            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', handleLike);
            });
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', toggleComments);
            });
            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', handleComment);
            });
            document.querySelectorAll('.follow-btn').forEach(btn => {
                btn.addEventListener('click', handleFollow);
            });
            document.querySelectorAll('.username').forEach(span => {
                span.addEventListener('click', () => {
                    showSection('otherProfileSection');
                    fetchUserProfile(span.dataset.user);
                });
            });
        }

        // Handle post creation
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const title = document.getElementById('carTitle').value;
            const price = document.getElementById('carPrice').value;
            const description = document.getElementById('carDescription').value;
            const image = document.getElementById('carImage').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ title, price, description, image })
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to create post');
                }

                fetchPosts();
                e.target.reset();
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle liking a post
        async function handleLike(e) {
            const postId = e.target.dataset.id;

            try {
                const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to like post');
                }

                fetchPosts();
            } catch (error) {
                displayError(error.message);
            }
        }

        // Toggle comments section
        function toggleComments(e) {
            const postId = e.target.dataset.id;
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Handle commenting
        async function handleComment(e) {
            if (e.key !== 'Enter') return;
            const postId = e.target.dataset.id;
            const text = e.target.value.trim();
            if (!text) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ text })
                });

                const post = await response.json();
                if (!response.ok) {
                    throw new Error(post.error || 'Failed to comment');
                }

                e.target.value = '';
                fetchPosts();
            } catch (error) {
                displayError(error.message);
            }
        }

        // Handle following a user
        async function handleFollow(e) {
            const userId = e.target.dataset.user;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/follow`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to follow/unfollow');
                }

                // Refresh current user data
                const userResponse = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                currentUser = await userResponse.json();

                // Refresh the current view
                if (document.getElementById('homeSection').classList.contains('active')) {
                    fetchPosts();
                } else if (document.getElementById('profileSection').classList.contains('active')) {
                    fetchUserProfile();
                } else if (document.getElementById('otherProfileSection').classList.contains('active')) {
                    fetchUserProfile(userId);
                }
            } catch (error) {
                displayError(error.message);
            }
        }

        // Search functionality
        document.getElementById('searchBar').addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.includes('about')) {
                showSection('aboutSection');
                return;
            }
            if (query.includes('contact')) {
                showSection('contactSection');
                return;
            }

            if (!query) {
                document.getElementById('searchResults').style.display = 'none';
                fetchPosts();
                return;
            }

            // Search users
            try {
                const userResponse = await fetch(`${API_BASE_URL}/api/users/search/${query}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const users = await userResponse.json();

                const searchResults = document.getElementById('searchResults');
                searchResults.style.display = 'block';
                searchResults.innerHTML = users.map(user => `
                    <div class="user" data-user="${user._id}">
                        <img src="${user.profilePicture}" alt="${user.username}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                        ${user.username}
                    </div>
                `).join('');

                document.querySelectorAll('.user').forEach(userDiv => {
                    userDiv.addEventListener('click', () => {
                        showSection('otherProfileSection');
                        fetchUserProfile(userDiv.dataset.user);
                    });
                });

                // Search posts
                fetchPosts(query);
            } catch (error) {
                displayError(error.message);
            }
        });
    </script>
</body>
</html>
