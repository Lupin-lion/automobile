<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automobile App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        h1, h2 {
            text-align: center;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        input, select, button {
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #profile, #error {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Automobile App</h1>

    <!-- Registration Form -->
    <h2>Register</h2>
    <form id="registerForm">
        <input type="text" id="regFirstName" placeholder="First Name" required>
        <input type="text" id="regLastName" placeholder="Last Name" required>
        <input type="text" id="regPhoneNumber" placeholder="Phone Number (e.g., +1234567890)" required>
        <input type="password" id="regPassword" placeholder="Password" required>
        <input type="date" id="regDob" required>
        <select id="regGender" required>
            <option value="" disabled selected>Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
        </select>
        <button type="submit">Register</button>
    </form>

    <!-- Login Form -->
    <h2>Login</h2>
    <form id="loginForm">
        <input type="text" id="loginPhoneNumber" placeholder="Phone Number" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>

    <!-- Profile Section -->
    <h2>Profile</h2>
    <button id="fetchProfile">Fetch Profile</button>
    <div id="profile"></div>

    <!-- Error Section -->
    <div id="error"></div>

    <script>
        // Set the API base URL to the deployed Heroku backend
        const API_BASE_URL = 'https://themartsbackend-b1ad232b40bb.herokuapp.com';

        // Helper function to display errors
        function displayError(message) {
            document.getElementById('error').textContent = message;
        }

        // Helper function to clear errors
        function clearError() {
            document.getElementById('error').textContent = '';
        }

        // Helper function to display profile
        function displayProfile(user) {
            const profileDiv = document.getElementById('profile');
            profileDiv.innerHTML = `
                <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Phone Number:</strong> ${user.phoneNumber}</p>
                <p><strong>Gender:</strong> ${user.gender}</p>
                <p><strong>Date of Birth:</strong> ${new Date(user.dob).toLocaleDateString()}</p>
                <p><strong>Bio:</strong> ${user.bio || 'Not set'}</p>
            `;
        }

        // Handle Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const phoneNumber = document.getElementById('regPhoneNumber').value;
            const password = document.getElementById('regPassword').value;
            const dob = document.getElementById('regDob').value;
            const gender = document.getElementById('regGender').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phoneNumber,
                        password,
                        dob,
                        gender
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                // Save token to localStorage
                localStorage.setItem('token', data.token);
                displayError('Registration successful! You can now log in.');
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            const phoneNumber = document.getElementById('loginPhoneNumber').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber,
                        password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                // Save token to localStorage
                localStorage.setItem('token', data.token);
                displayError('Login successful! You can now fetch your profile.');
            } catch (error) {
                displayError(error.message);
            }
        });

        // Handle Fetch Profile
        document.getElementById('fetchProfile').addEventListener('click', async () => {
            clearError();
            document.getElementById('profile').innerHTML = '';

            const token = localStorage.getItem('token');
            if (!token) {
                displayError('No token found. Please register or log in first.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch profile');
                }

                displayProfile(data);
            } catch (error) {
                displayError(error.message);
            }
        });
    </script>
</body>
</html>
