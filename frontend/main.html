<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheMarts Automobiles</title>
</head>
<body>
    <nav>
        <h1 id="homeLink">TheMarts</h1>
        <div class="nav-links">
            <a href="#" id="homeNavLink">Home</a>
            <a href="#" id="profileLink">Profile</a>
            <a href="#" id="messagesLink">Messages</a>
            <a href="#" id="notificationsLink">Notifications <span id="notificationCount" style="display: none;">0</span></a>
            <a href="#" id="aboutLink">About</a>
            <a href="#" id="contactLink">Contact</a>
            <a href="#" id="logoutLink">Logout</a>
        </div>
        <input type="text" id="searchBar" placeholder="Search users or posts...">
    </nav>

    <div class="container">
        <p id="error"></p>
        <div id="searchResults" style="display: none;"></div>

        <div id="loginSection" class="section">
            <div class="auth-form">
                <h2>Login</h2>
                <form id="loginForm">
                    <input type="text" id="loginPhoneNumber" placeholder="Phone Number" required>
                    <div class="password-container">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePassword('loginPassword')">Show</span>
                    </div>
                    <button type="submit">Login</button>
                </form>
                <p>Not registered? <a href="#" onclick="showSection('registerSection')">Register here</a></p>
            </div>
        </div>

        <div id="registerSection" class="section">
            <div class="auth-form">
                <h2>Register</h2>
                <form id="registerForm">
                    <input type="text" id="regFirstName" placeholder="First Name" required>
                    <input type="text" id="regLastName" placeholder="Last Name" required>
                    <input type="text" id="regPhoneNumber" placeholder="Phone Number" required>
                    <div class="password-container">
                        <input type="password" id="regPassword" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePassword('regPassword')">Show</span>
                    </div>
                    <input type="date" id="regDob" required>
                    <select id="regGender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <button type="submit">Register</button>
                </form>
                <p>Already registered? <a href="#" onclick="showSection('loginSection')">Login here</a></p>
            </div>
        </div>

        <div id="homeSection" class="section">
            <button class="create-post-btn" onclick="showSection('postSection')">Create New Post</button>
            <div id="carListings"></div>
        </div>

        <div id="postSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="post-form">
                <h2>Create Post</h2>
                <form id="carForm">
                    <input type="text" id="carTitle" placeholder="Car Title" required>
                    <input type="text" id="carPrice" placeholder="Price" required>
                    <textarea id="carDescription" placeholder="Description" required></textarea>
                    <input type="file" id="carImage" accept="image/*">
                    <button type="submit">Post</button>
                </form>
            </div>
        </div>

        <div id="profileSection" class="section">
            <div class="profile">
                <div class="cover-photo"></div>
                <div class="profile-header">
                    <img id="profilePicture" src="https://via.placeholder.com/120" alt="Profile Picture">
                    <div class="info">
                        <h2 id="profileUsername"></h2>
                        <button class="edit-profile-btn" onclick="showEditProfileForm()">Edit Profile</button>
                    </div>
                </div>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span id="profileName"></span></p>
                    <p><strong>Gender:</strong> <span id="profileGender"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="profileDob"></span></p>
                    <p><strong>Bio:</strong> <span id="profileBio"></span></p>
                    <p><strong>Followers:</strong> <span id="profileFollowersCount">0</span></p>
                </div>
                <div class="followers-list" id="followersList">
                    <h3>Followers</h3>
                </div>
                <form id="editProfileForm" class="edit-profile-form">
                    <textarea id="editBio" placeholder="Bio"></textarea>
                    <input type="file" id="editProfilePicture" accept="image/*">
                    <button type="submit" class="save-profile-btn">Save</button>
                    <button type="button" class="back-btn" onclick="hideEditProfileForm()">Cancel</button>
                </form>
            </div>
        </div>

        <div id="otherProfileSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="profile">
                <div class="cover-photo"></div>
                <div class="profile-header">
                    <img id="otherProfilePicture" src="https://via.placeholder.com/120" alt="Profile Picture">
                    <div class="info">
                        <h2 id="otherProfileUsername"></h2>
                        <button class="follow-btn" id="otherProfileFollowBtn"></button>
                        <button class="connect-btn" id="connectBtn">Connect</button>
                    </div>
                </div>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span id="otherProfileName"></span></p>
                    <p><strong>Gender:</strong> <span id="otherProfileGender"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="otherProfileDob"></span></p>
                    <p><strong>Bio:</strong> <span id="otherProfileBio"></span></p>
                    <p><strong>Followers:</strong> <span id="otherProfileFollowersCount">0</span></p>
                </div>
                <div class="followers-list" id="otherFollowersList">
                    <h3>Followers</h3>
                </div>
            </div>
        </div>

        <div id="messagesSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="messages">
                <h2>Messages</h2>
                <div id="messageThreads"></div>
                <form id="messageForm" class="message-form">
                    <input type="text" id="messageReceiver" placeholder="Recipient Username">
                    <textarea id="messageContent" placeholder="Type your message..."></textarea>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>

        <div id="notificationsSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="notifications">
                <h2>Notifications</h2>
                <div id="notificationList"></div>
            </div>
        </div>

        <div id="aboutSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="about">
                <h2>About TheMarts</h2>
                <p>TheMarts Automobiles is a vibrant community for car enthusiasts, buyers, and sellers. Our platform connects people passionate about automobiles, offering a space to share, discover, and trade cars with ease.</p>
                <h3>Our Mission</h3>
                <p>Our mission is to revolutionize the way people buy and sell cars by providing a seamless, transparent, and community-driven platform. We aim to empower users with the tools and connections they need to make informed decisions.</p>
                <h3>Our Founders</h3>
                <div class="founders-grid">
                    <div class="founder-card">
                        <img class="founder-image" src="colince.jpg" alt="Colince">
                        <h4>Colince Lupin</h4>
                        <p class="founder-title">CEO & Founder</p>
                        <p class="founder-bio">Colince is a visionary leader with a passion for automobiles and technology. With over 15 years in the automotive industry, he founded TheMarts to bridge the gap between car enthusiasts and the digital world.</p>
                        <div class="founder-contact">
                            <p>Email: colincesibuor122@gmail.com</p>
                            <p>Phone: +245799582173</p>
                        </div>
                    </div>
                    <div class="founder-card">
                        <img class="founder-image" src="victor.jpg" alt="Victor Martin">
                        <h4>Victor Martin</h4>
                        <p class="founder-title">COO & Co-Founder</p>
                        <p class="founder-bio">Martin brings operational excellence to TheMarts. His expertise in logistics and customer experience ensures our platform runs smoothly, delivering value to every user.</p>
                        <div class="founder-contact">
                            <p>Email: themarts.com</p>
                            <p>Phone: +1-555-987-6543</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="contactSection" class="section">
            <button class="back-btn" onclick="showSection('homeSection')">Back to Home</button>
            <div class="contact">
                <h2>Contact Us</h2>
                <p>Have questions or need assistance? Reach out to our team, and we'll get back to you as soon as possible.</p>
                <form id="contactForm">
                    <input type="text" id="contactBusinessName" placeholder="Business Name" required>
                    <input type="text" id="contactPhoneNumber" placeholder="Phone Number" required>
                    <textarea id="contactMessage" placeholder="Your Message" required></textarea>
                    <button type="submit">Send Message</button>
                </form>
                <p>Email: support@themarts.com | Phone: +1-555-012-3456</p>
            </div>
        </div>
    </div>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #e9ecef;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: -1;
        }

        nav {
            background: linear-gradient(90deg, #2c3e50, #3498db);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav h1 {
            font-size: 28px;
            font-weight: 700;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        nav h1:hover {
            color: #ffd700;
        }

        nav .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        nav .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        nav .nav-links a:hover {
            color: #ffd700;
            transform: scale(1.2);
        }

        nav input {
            padding: 10px 15px;
            width: 350px;
            border-radius: 25px;
            border: none;
            outline: none;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: background 0.3s ease;
        }

        nav input:focus {
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .section {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            width: 100%;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .section.active {
            opacity: 1;
            visibility: visible;
            position: relative;
        }

        .auth-form, .post-form, .car-post, .profile, .about, .contact, .messages, .notifications {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .auth-form:hover, .post-form:hover, .car-post:hover, .profile:hover, .about:hover, .contact:hover, .messages:hover, .notifications:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .auth-form form, .post-form form, .edit-profile-form, .message-form, .contact form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form .password-container {
            position: relative;
        }

        .auth-form .password-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .auth-form .password-container input:focus {
            border-color: #3498db;
            outline: none;
        }

        .auth-form .password-container .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #3498db;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-form input, .post-form input, .post-form textarea, .auth-form select, .edit-profile-form input, .edit-profile-form textarea, .message-form input, .message-form textarea, .contact input, .contact textarea {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            background: #f8f9fa;
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        .auth-form input:focus, .post-form input:focus, .post-form textarea:focus, .auth-form select:focus, .edit-profile-form input:focus, .edit-profile-form textarea:focus, .message-form input:focus, .message-form textarea:focus, .contact input:focus, .contact textarea:focus {
            border-color: #3498db;
            background: white;
            outline: none;
        }

        .auth-form button, .post-form button, .create-post-btn, .back-btn, .edit-profile-btn, .save-profile-btn, .message-form button, .connect-btn, .delete-btn, .contact button {
            padding: 12px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .auth-form button:hover, .post-form button:hover, .create-post-btn:hover, .back-btn:hover, .edit-profile-btn:hover, .save-profile-btn:hover, .message-form button:hover, .connect-btn:hover, .delete-btn:hover, .contact button:hover {
            background: linear-gradient(45deg, #2980b9, #1f618d);
            transform: scale(1.02);
        }

        .delete-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .delete-btn:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .car-post {
            position: relative;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 20px;
        }

        .car-post img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 15px;
            transition: transform 0.3s ease;
        }

        .car-post img:hover {
            transform: scale(1.01);
        }

        .car-post h3 {
            margin: 15px 0;
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
        }

        .car-post p {
            color: #6c757d;
            font-size: 15px;
            line-height: 1.6;
        }

        .car-post .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .car-post .post-header img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #3498db;
        }

        .car-post .post-header .username {
            font-size: 16px;
            font-weight: 600;
            color: #3498db;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .car-post .post-header .username:hover {
            color: #2980b9;
        }

        .car-post .post-header .verified-tick {
            font-size: 16px;
            margin-left: 6px;
        }

        .car-post .follow-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-left: auto;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .car-post .follow-btn.following {
            background: #e9ecef;
            color: #2c3e50;
        }

        .car-post .follow-btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f618d);
            transform: scale(1.05);
        }

        .car-post .actions {
            margin-top: 15px;
            display: flex;
            gap: 12px;
            border-top: 1px solid #dee2e6;
            padding-top: 12px;
        }

        .car-post .actions button {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .car-post .actions button:hover {
            background: #f1f3f5;
            border-radius: 6px;
            color: #2c3e50;
        }

        .car-post .like-btn.liked {
            color: #3498db;
        }

        .comments {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .comments input {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            font-size: 15px;
            background: #f8f9fa;
        }

        .comments .comment {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comments .comment img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comments .comment div {
            background: #f1f3f5;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 15px;
            color: #2c3e50;
        }

        .comments .comment div strong {
            font-weight: 600;
        }

        .comments .comment div .verified-tick {
            font-size: 14px;
            margin-left: 6px;
        }

        .profile {
            text-align: left;
        }

        .profile .cover-photo {
            width: 100%;
            height: 250px;
            background: linear-gradient(45deg, #3498db, #2c3e50);
            border-radius: 12px 12px 0 0;
        }

        .profile .profile-header {
            position: relative;
            margin-top: -70px;
            padding: 0 25px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .profile .profile-header img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid white;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .profile .profile-header .info {
            flex: 1;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .profile .profile-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
        }

        .profile .profile-header .verified-tick {
            font-size: 20px;
            margin-left: 6px;
        }

        .profile .profile-header .follow-btn, .connect-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .profile .profile-header .follow-btn.following {
            background: #e9ecef;
            color: #2c3e50;
        }

        .profile .profile-header .follow-btn:hover, .connect-btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f618d);
            transform: scale(1.05);
        }

        .profile .profile-details {
            padding: 25px;
            border-top: 1px solid #dee2e6;
        }

        .profile .profile-details p {
            margin: 10px 0;
            font-size: 15px;
            color: #2c3e50;
        }

        .profile .profile-details p strong {
            color: #6c757d;
        }

        .profile .followers-list {
            margin-top: 25px;
        }

        .profile .followers-list h3 {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .profile .followers-list .follower {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .profile .followers-list .follower:hover {
            background: #f1f3f5;
        }

        .profile .followers-list .follower img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile .followers-list .follower span {
            font-size: 15px;
            font-weight: 500;
            color: #2c3e50;
        }

        .profile .followers-list .follower .verified-tick {
            font-size: 14px;
            margin-left: 6px;
        }

        .search-results {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-results .user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .search-results .user:last-child {
            border-bottom: none;
        }

        .search-results .user:hover {
            background: #f1f3f5;
        }

        .search-results .user img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .search-results .user span {
            font-size: 15px;
            font-weight: 500;
            color: #2c3e50;
        }

        .search-results .user .verified-tick {
            font-size: 14px;
            margin-left: 6px;
        }

        .about, .contact {
            line-height: 1.7;
            font-size: 15px;
            color: #2c3e50;
        }

        .about h2, .about h3, .contact h2 {
            color: #2c3e50;
            text-align: center;
        }

        .about p, .contact p {
            line-height: 1.6;
            color: #34495e;
        }

        .founders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .founder-card {
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }

        .founder-card:hover {
            transform: translateY(-5px);
        }

        .founder-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }

        .founder-card h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .founder-title {
            font-style: italic;
            color: #7f8c8d;
            margin: 5px 0;
        }

        .founder-bio {
            font-size: 0.9em;
            color: #34495e;
            margin-bottom: 15px;
        }

        .founder-contact p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .about a, .contact a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .about a:hover, .contact a:hover {
            color: #2980b9;
        }

        @media (max-width: 600px) {
            .founders-grid {
                grid-template-columns: 1fr;
            }
        }

        #error {
            color: #e74c3c;
            text-align: center;
            margin-bottom: 25px;
            font-size: 15px;
            font-weight: 500;
        }

        .create-post-btn {
            margin-bottom: 25px;
            display: block;
            width: 100%;
            text-align: center;
            background: #f1f3f5;
            color: #2c3e50;
            font-weight: 600;
            padding: 15px;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .create-post-btn:hover {
            background: #e9ecef;
            transform: scale(1.01);
        }

        .back-btn {
            margin-bottom: 15px;
            display: block;
            background: #e9ecef;
            color: #2c3e50;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .back-btn:hover {
            background: #dee2e6;
            transform: scale(1.02);
        }

        .edit-profile-form {
            display: none;
        }

        .edit-profile-form.active {
            display: flex;
        }

        .messages .message-thread {
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 25px;
            padding-right: 10px;
        }

        .messages .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .messages .message img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .messages .message div {
            background: #f1f3f5;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 15px;
            color: #2c3e50;
        }

        .messages .message.sent div {
            background: #3498db;
            color: white;
        }

        .messages .message div .verified-tick {
            font-size: 14px;
            margin-left: 6px;
        }

        .notifications .notification {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .notifications .notification:last-child {
            border-bottom: none;
        }

        .notifications .notification.unread {
            background: #e7f3ff;
        }

        .notifications .notification:hover {
            background: #f1f3f5;
        }

        .notifications .notification img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .notifications .notification span {
            font-size: 15px;
            color: #2c3e50;
        }

        .notification-count {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 3px 9px;
            font-size: 13px;
            position: relative;
            top: -12px;
            left: -6px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f3f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('homeLink').addEventListener('click', () => showSection('homeSection'));
    document.getElementById('homeNavLink').addEventListener('click', (e) => { e.preventDefault(); showSection('homeSection'); });
    document.getElementById('profileLink').addEventListener('click', (e) => { e.preventDefault(); showSection('profileSection'); });
    document.getElementById('messagesLink').addEventListener('click', (e) => { e.preventDefault(); showSection('messagesSection'); });
    document.getElementById('notificationsLink').addEventListener('click', (e) => { e.preventDefault(); showSection('notificationsSection'); });
    document.getElementById('aboutLink').addEventListener('click', (e) => { e.preventDefault(); showSection('aboutSection'); });
    document.getElementById('contactLink').addEventListener('click', (e) => { e.preventDefault(); showSection('contactSection'); });
    document.getElementById('logoutLink').addEventListener('click', (e) => { e.preventDefault(); logout(); });
});

const API_BASE_URL = 'https://themarts-backend-31fba5d23679.herokuapp.com';
let currentUser = null;
let currentChatUserId = null;

function showSection(sectionId, userId = null) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.style.opacity = '0';
        section.style.visibility = 'hidden';
    });
    const targetSection = document.getElementById(sectionId);
    targetSection.classList.add('active');
    setTimeout(() => {
        targetSection.style.opacity = '1';
        targetSection.style.visibility = 'visible';
    }, 10);
    document.getElementById('error').textContent = '';
    document.getElementById('searchBar').value = '';

    if (sectionId === 'homeSection') {
        fetchPosts();
        fetchNotifications();
    } else if (sectionId === 'profileSection') {
        fetchUserProfile();
    } else if (sectionId === 'otherProfileSection' && userId) {
        fetchUserProfile(userId);
    } else if (sectionId === 'messagesSection') {
        fetchMessageThreads();
    } else if (sectionId === 'notificationsSection') {
        fetchNotifications(true);
    }
}

function displayError(message) {
    document.getElementById('error').textContent = message;
}

function clearError() {
    document.getElementById('error').textContent = '';
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const toggleText = input.nextElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        toggleText.textContent = 'Hide';
    } else {
        input.type = 'password';
        toggleText.textContent = 'Show';
    }
}

function showEditProfileForm() {
    document.getElementById('editProfileForm').classList.add('active');
    document.querySelector('.profile-details').style.display = 'none';
    document.querySelector('.edit-profile-btn').style.display = 'none';
}

function hideEditProfileForm() {
    document.getElementById('editProfileForm').classList.remove('active');
    document.querySelector('.profile-details').style.display = 'block';
    document.querySelector('.edit-profile-btn').style.display = 'block';
    fetchUserProfile();
}

(async function initializeApp() {
    const token = localStorage.getItem('token');
    if (token) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const user = await response.json();
            if (response.ok) {
                currentUser = user;
                showSection('homeSection');
                fetchNotifications();
            } else {
                localStorage.removeItem('token');
                showSection('loginSection');
            }
        } catch (error) {
            console.error('Failed to fetch user profile:', error);
            localStorage.removeItem('token');
            showSection('loginSection');
        }
    } else {
        showSection('loginSection');
    }
})();

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const phoneNumber = document.getElementById('loginPhoneNumber').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const response = await fetch(`${API_BASE_URL}/api/users/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phoneNumber, password })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Login failed');
        }

        localStorage.setItem('token', data.token);
        currentUser = data.user;
        showSection('homeSection');
        fetchPosts();
        fetchNotifications();
    } catch (error) {
        displayError(error.message);
    }
});

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const firstName = document.getElementById('regFirstName').value;
    const lastName = document.getElementById('regLastName').value;
    const phoneNumber = document.getElementById('regPhoneNumber').value;
    const password = document.getElementById('regPassword').value;
    const dob = document.getElementById('regDob').value;
    const gender = document.getElementById('regGender').value;

    try {
        const response = await fetch(`${API_BASE_URL}/api/users/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                firstName,
                lastName,
                phoneNumber,
                password,
                dob,
                gender
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Registration failed');
        }

        localStorage.setItem('token', data.token);
        currentUser = data.user;
        showSection('homeSection');
        fetchPosts();
        fetchNotifications();
    } catch (error) {
        displayError(error.message);
    }
});

document.getElementById('contactForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    const businessName = document.getElementById('contactBusinessName').value;
    const phoneNumber = document.getElementById('contactPhoneNumber').value;
    const message = document.getElementById('contactMessage').value;
    alert(`Contact form submitted:\nBusiness: ${businessName}\nPhone: ${phoneNumber}\nMessage: ${message}`);
    e.target.reset();
});

function logout() {
    localStorage.removeItem('token');
    currentUser = null;
    showSection('loginSection');
}

async function fetchUserProfile(userId = null) {
    try {
        const url = userId ? `${API_BASE_URL}/api/users/${userId}` : `${API_BASE_URL}/api/users/profile`;
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const user = await response.json();
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(user.error || 'Failed to fetch profile');
        }

        const profileDiv = userId ? document.getElementById('otherUserProfile') : document.getElementById('userProfile');
        const isFollowing = user.followers.includes(currentUser?._id || '');

        if (userId) {
            document.getElementById('otherProfilePicture').src = user.profilePicture || 'https://via.placeholder.com/120';
            document.getElementById('otherProfileUsername').innerHTML = `${user.username || 'Unknown User'}${user.verified ? '<span class="verified-tick">✅</span>' : ''}`;
            document.getElementById('otherProfileName').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('otherProfileGender').textContent = user.gender;
            document.getElementById('otherProfileDob').textContent = new Date(user.dob).toLocaleDateString();
            document.getElementById('otherProfileBio').textContent = user.bio || 'Not set';
            document.getElementById('otherProfileFollowersCount').textContent = user.followers.length;

            const followBtn = document.getElementById('otherProfileFollowBtn');
            followBtn.textContent = isFollowing ? 'Following' : 'Follow';
            followBtn.className = `follow-btn ${isFollowing ? 'following' : ''}`;
            followBtn.dataset.user = user._id;

            const connectBtn = document.getElementById('connectBtn');
            connectBtn.dataset.user = user._id;
            connectBtn.onclick = () => {
                currentChatUserId = user._id;
                showSection('messagesSection');
                fetchMessages(user._id);
            };

            const followersList = document.getElementById('otherFollowersList');
            followersList.innerHTML = '<h3>Followers</h3>';
            for (const followerId of user.followers) {
                const followerResponse = await fetch(`${API_BASE_URL}/api/users/${followerId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const follower = await followerResponse.json();
                const followerDiv = document.createElement('div');
                followerDiv.classList.add('follower');
                followerDiv.dataset.user = follower._id;
                followerDiv.innerHTML = `
                    <img src="${follower.profilePicture || 'https://via.placeholder.com/40'}" alt="${follower.username || 'Unknown User'}">
                    <span>${follower.username || 'Unknown User'}${follower.verified ? '<span class="verified-tick">✅</span>' : ''}</span>
                `;
                followerDiv.onclick = () => {
                    showSection('otherProfileSection', follower._id);
                };
                followersList.appendChild(followerDiv);
            }
        } else {
            document.getElementById('profilePicture').src = user.profilePicture || 'https://via.placeholder.com/120';
            document.getElementById('profileUsername').innerHTML = `${user.username || 'Unknown User'}${user.verified ? '<span class="verified-tick">✅</span>' : ''}`;
            document.getElementById('profileName').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('profileGender').textContent = user.gender;
            document.getElementById('profileDob').textContent = new Date(user.dob).toLocaleDateString();
            document.getElementById('profileBio').textContent = user.bio || 'Not set';
            document.getElementById('profileFollowersCount').textContent = user.followers.length;

            const followersList = document.getElementById('followersList');
            followersList.innerHTML = '<h3>Followers</h3>';
            for (const followerId of user.followers) {
                const followerResponse = await fetch(`${API_BASE_URL}/api/users/${followerId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const follower = await followerResponse.json();
                const followerDiv = document.createElement('div');
                followerDiv.classList.add('follower');
                followerDiv.dataset.user = follower._id;
                followerDiv.innerHTML = `
                    <img src="${follower.profilePicture || 'https://via.placeholder.com/40'}" alt="${follower.username || 'Unknown User'}">
                    <span>${follower.username || 'Unknown User'}${follower.verified ? '<span class="verified-tick">✅</span>' : ''}</span>
                `;
                followerDiv.onclick = () => {
                    showSection('otherProfileSection', follower._id);
                };
                followersList.appendChild(followerDiv);
            }
        }
    } catch (error) {
        displayError(error.message);
    }
}

document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const bio = document.getElementById('editBio').value;
    const profilePicture = document.getElementById('editProfilePicture').files[0];

    const formData = new FormData();
    if (bio) formData.append('bio', bio);
    if (profilePicture) formData.append('profilePicture', profilePicture);

    try {
        const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
        });

        const user = await response.json();
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(user.error || 'Failed to update profile');
        }

        currentUser = user;
        hideEditProfileForm();
    } catch (error) {
        displayError(error.message);
    }
});

async function fetchPosts(searchTerm = '') {
    try {
        const url = searchTerm ? `${API_BASE_URL}/api/posts/search/${searchTerm}` : `${API_BASE_URL}/api/posts`;
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const posts = await response.json();
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(posts.error || 'Failed to fetch posts');
        }

        displayPosts(posts);
    } catch (error) {
        displayError(error.message);
    }
}

async function displayPosts(posts) {
    const listingsDiv = document.getElementById('carListings');
    if (!listingsDiv) {
        console.error('carListings div not found in DOM');
        return;
    }
    listingsDiv.innerHTML = '';

    if (posts.length === 0) {
        listingsDiv.innerHTML = '<p>No posts available.</p>';
        return;
    }

    for (const post of posts) {
        const user = post.user || { profilePicture: 'https://via.placeholder.com/40', username: 'Unknown User', _id: '', verified: false };
        const hasLiked = currentUser ? post.likes.includes(currentUser._id) : false;
        const isOwnPost = currentUser && post.user && post.user._id === currentUser._id;
        const carDiv = document.createElement('div');
        carDiv.classList.add('car-post');
        carDiv.innerHTML = `
            <div class="post-header">
                <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.username || 'Unknown User'}" data-user="${user._id}" />
                <span class="username" data-user="${user._id}">${user.username || 'Unknown User'}${user.verified ? '<span class="verified-tick">✅</span>' : ''}</span>
                ${user._id && user._id !== currentUser?._id ? `<button class="follow-btn ${currentUser && currentUser.following && currentUser.following.includes(user._id) ? 'following' : ''}" data-user="${user._id}">${currentUser && currentUser.following && currentUser.following.includes(user._id) ? 'Following' : 'Follow'}</button>` : ''}
            </div>
            <h3>${post.title}</h3>
            <p><strong>Price:</strong> ${post.price}</p>
            <p>${post.description}</p>
            <img src="${post.image}" alt="${post.title}" />
            <div class="actions">
                <button class="like-btn ${hasLiked ? 'liked' : ''}" data-id="${post._id}">
                    Like (${post.likes.length})
                </button>
                <button class="comment-btn" data-id="${post._id}">Comment (${post.comments.length})</button>
                ${isOwnPost ? `<button class="delete-btn" data-id="${post._id}">Delete</button>` : ''}
            </div>
            <div class="comments" id="comments-${post._id}" style="display: none;"></div>
        `;

        listingsDiv.appendChild(carDiv);

        const commentsDiv = document.getElementById(`comments-${post._id}`);
        for (const comment of post.comments) {
            const commenter = comment.user || { profilePicture: 'https://via.placeholder.com/32', username: 'Unknown User', verified: false };
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment');
            commentDiv.innerHTML = `
                <img src="${commenter.profilePicture || 'https://via.placeholder.com/32'}" alt="${commenter.username || 'Unknown User'}" />
                <div>
                    <strong>${commenter.username || 'Unknown User'}${commenter.verified ? '<span class="verified-tick">✅</span>' : ''}</strong>
                    <p>${comment.text}</p>
                </div>
            `;
            commentsDiv.appendChild(commentDiv);
        }

        const commentInput = document.createElement('input');
        commentInput.type = 'text';
        commentInput.className = 'comment-input';
        commentInput.placeholder = 'Write a comment...';
        commentInput.dataset.id = post._id;
        commentsDiv.appendChild(commentInput);
    }

    attachEventListeners();
}

function attachEventListeners() {
    const carListings = document.getElementById('carListings');
    if (!carListings) return;

    carListings.onclick = async (e) => {
        if (e.target.classList.contains('like-btn')) {
            const postId = e.target.dataset.id;
            if (!postId) {
                displayError('Invalid post ID');
                return;
            }
            await handleLike(postId);
        } else if (e.target.classList.contains('comment-btn')) {
            const postId = e.target.dataset.id;
            toggleComments(postId);
        } else if (e.target.classList.contains('delete-btn')) {
            const postId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this post?')) {
                await handleDelete(postId);
            }
        } else if (e.target.classList.contains('follow-btn')) {
            const userId = e.target.dataset.user;
            await handleFollow(userId);
        } else if (e.target.classList.contains('username') || (e.target.tagName === 'IMG' && e.target.parentElement.classList.contains('post-header'))) {
            const userId = e.target.dataset.user;
            if (userId && userId !== currentUser?._id) {
                showSection('otherProfileSection', userId);
            }
        }
    };

    carListings.onkeypress = async (e) => {
        if (e.target.classList.contains('comment-input') && e.key === 'Enter') {
            const postId = e.target.dataset.id;
            await handleComment(postId, e.target);
        }
    };

    const otherProfileFollowBtn = document.getElementById('otherProfileFollowBtn');
    if (otherProfileFollowBtn) {
        otherProfileFollowBtn.onclick = async () => {
            const userId = otherProfileFollowBtn.dataset.user;
            await handleFollow(userId);
        };
    }
}

document.getElementById('carForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const title = document.getElementById('carTitle').value;
    const price = document.getElementById('carPrice').value;
    const description = document.getElementById('carDescription').value;
    const image = document.getElementById('carImage').files[0];

    const formData = new FormData();
    formData.append('title', title);
    formData.append('price', price);
    formData.append('description', description);
    if (image) {
        formData.append('image', image);
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/posts`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
        });

        const post = await response.json();
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(post.error || 'Failed to create post');
        }

        showSection('homeSection');
        fetchPosts();
        e.target.reset();
    } catch (error) {
        displayError(error.message);
    }
});

async function handleLike(postId) {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('Please log in to like posts.');
        }
        if (!postId || typeof postId !== 'string' || postId.length !== 24) {
            throw new Error('Invalid post ID');
        }

        const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(errorData.error || 'Failed to like/unlike post');
        }

        fetchPosts();
        fetchNotifications();
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}

async function handleDelete(postId) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to delete post');
        }

        fetchPosts();
    } catch (error) {
        displayError(error.message);
    }
}

function toggleComments(postId) {
    const commentsDiv = document.getElementById(`comments-${postId}`);
    commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
}

async function handleComment(postId, input) {
    const text = input.value.trim();
    if (!text) return;

    try {
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('Please log in to comment.');
        }

        const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ text })
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(errorData.error || 'Failed to comment');
        }

        input.value = '';
        fetchPosts();
        fetchNotifications();
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}

async function handleFollow(userId) {
    if (!userId || userId.length !== 24) {
        displayError('Cannot follow: Invalid user ID.');
        return;
    }
    if (userId === currentUser?._id) {
        displayError('You cannot follow yourself.');
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/users/${userId}/follow`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(errorData.error || 'Failed to follow/unfollow user');
        }

        const userResponse = await fetch(`${API_BASE_URL}/api/users/profile`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!userResponse.ok) {
            throw new Error('Failed to refresh user data');
        }
        currentUser = await userResponse.json();

        if (document.getElementById('homeSection').classList.contains('active')) {
            fetchPosts();
        } else if (document.getElementById('profileSection').classList.contains('active')) {
            fetchUserProfile();
        } else if (document.getElementById('otherProfileSection').classList.contains('active')) {
            fetchUserProfile(userId);
        }
        fetchNotifications();
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}

document.getElementById('searchBar').addEventListener('input', async (e) => {
    const query = e.target.value.trim().toLowerCase();

    if (query.includes('about')) {
        showSection('aboutSection');
        return;
    }
    if (query.includes('contact')) {
        showSection('contactSection');
        return;
    }

    if (!query) {
        document.getElementById('searchResults').style.display = 'none';
        fetchPosts();
        return;
    }

    try {
        const userResponse = await fetch(`${API_BASE_URL}/api/users/search/${query}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        const users = await userResponse.json();

        if (!userResponse.ok) {
            if (userResponse.status === 401 || userResponse.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(users.error || 'Failed to search users');
        }

        const searchResults = document.getElementById('searchResults');
        searchResults.style.display = 'block';
        searchResults.innerHTML = users.map(user => `
            <div class="user" data-user="${user._id}">
                <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.username || 'Unknown User'}">
                <span>${user.username || 'Unknown User'}${user.verified ? '<span class="verified-tick">✅</span>' : ''}</span>
            </div>
        `).join('');

        document.querySelectorAll('.user').forEach(userDiv => {
            userDiv.onclick = () => {
                showSection('otherProfileSection', userDiv.dataset.user);
            };
        });

        fetchPosts(query);
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
});

async function fetchMessageThreads() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/users/search/`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error('Failed to fetch users for message threads');
        }

        const users = await response.json();

        const threads = new Map();
        for (const user of users) {
            if (user._id === currentUser._id) continue;
            const messagesResponse = await fetch(`${API_BASE_URL}/api/messages/${user._id}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });

            if (!messagesResponse.ok) {
                if (messagesResponse.status === 401 || messagesResponse.status === 403) {
                    localStorage.removeItem('token');
                    showSection('loginSection');
                    throw new Error('Session expired. Please log in again.');
                }
                continue;
            }

            const messages = await messagesResponse.json();
            if (messages.length > 0) {
                threads.set(user._id, { user, lastMessage: messages[messages.length - 1] });
            }
        }

        const threadsDiv = document.getElementById('messageThreads');
        threadsDiv.innerHTML = '';
        for (const [userId, thread] of threads) {
            const threadDiv = document.createElement('div');
            threadDiv.classList.add('user');
            threadDiv.dataset.user = userId;
            threadDiv.innerHTML = `
                <img src="${thread.user.profilePicture || 'https://via.placeholder.com/40'}" alt="${thread.user.username || 'Unknown User'}">
                <span>${thread.user.username || 'Unknown User'}${thread.user.verified ? '<span class="verified-tick">✅</span>' : ''}: ${thread.lastMessage.content}</span>
            `;
            threadDiv.onclick = () => {
                currentChatUserId = userId;
                fetchMessages(userId);
            };
            threadsDiv.appendChild(threadDiv);
        }

        if (currentChatUserId) {
            fetchMessages(currentChatUserId);
        }
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}

async function fetchMessages(userId) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/messages/${userId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error('Failed to fetch messages');
        }

        const messages = await response.json();
        const threadsDiv = document.getElementById('messageThreads');
        const chatUser = messages.length > 0 ? (messages[0].receiver._id === userId ? messages[0].receiver : messages[0].sender) : { username: 'Unknown User', verified: false };
        threadsDiv.innerHTML = `<h3>Conversation with ${chatUser.username || 'Unknown User'}${chatUser.verified ? '<span class="verified-tick">✅</span>' : ''}</h3>`;
        const messageThread = document.createElement('div');
        messageThread.classList.add('message-thread');
        messages.forEach(message => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', message.sender._id === currentUser._id ? 'sent' : 'received');
            messageDiv.innerHTML = `
                <img src="${message.sender.profilePicture || 'https://via.placeholder.com/32'}" alt="${message.sender.username || 'Unknown User'}">
                <div>
                    <strong>${message.sender.username || 'Unknown User'}${message.sender.verified ? '<span class="verified-tick">✅</span>' : ''}</strong>
                    <p>${message.content}</p>
                </div>
            `;
            messageThread.appendChild(messageDiv);
        });
        threadsDiv.appendChild(messageThread);
        messageThread.scrollTop = messageThread.scrollHeight;

        const messageForm = document.getElementById('messageForm');
        messageForm.onsubmit = async (e) => {
            e.preventDefault();
            const content = document.getElementById('messageContent').value.trim();
            if (!content) return;

            try {
                const userResponse = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!userResponse.ok) {
                    if (userResponse.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        showSection('loginSection');
                        throw new Error('Session expired. Please log in again.');
                    }
                    throw new Error('User not found');
                }

                const user = await userResponse.json();
                const receiverId = user._id;

                const response = await fetch(`${API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ receiverId, content })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        showSection('loginSection');
                        throw new Error('Session expired. Please log in again.');
                    }
                    throw new Error(errorData.error || 'Failed to send message');
                }

                e.target.reset();
                fetchMessages(receiverId);
                fetchNotifications();
            } catch (error) {
                displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
            }
        };
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}

document.getElementById('messageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const receiverUsername = document.getElementById('messageReceiver').value.trim();
    const content = document.getElementById('messageContent').value.trim();

    if (!receiverUsername || !content) return;

    try {
        const userResponse = await fetch(`${API_BASE_URL}/api/users/search/${receiverUsername}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!userResponse.ok) {
            if (userResponse.status === 401 || userResponse.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error('User not found');
        }

        const users = await userResponse.json();
        if (!users || users.length === 0) {
            throw new Error('User not found');
        }

        const receiverId = users[0]._id;

        const response = await fetch(`${API_BASE_URL}/api/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ receiverId, content })
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error(errorData.error || 'Failed to send message');
        }

        e.target.reset();
        fetchMessages(receiverId);
        fetchNotifications();
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
});

async function fetchNotifications(showAll = false) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/notifications${showAll ? '?all=true' : ''}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showSection('loginSection');
                throw new Error('Session expired. Please log in again.');
            }
            throw new Error('Failed to fetch notifications');
        }

        const notifications = await response.json();
        const notificationList = document.getElementById('notificationList');
        const notificationCount = document.getElementById('notificationCount');

        if (showAll && notificationList) {
            notificationList.innerHTML = notifications.length > 0 ? '' : '<p>No notifications available.</p>';
            for (const notification of notifications) {
                const notificationDiv = document.createElement('div');
                notificationDiv.classList.add('notification', notification.read ? '' : 'unread');
                notificationDiv.dataset.id = notification._id;
                notificationDiv.innerHTML = `
                    <img src="${notification.from.profilePicture || 'https://via.placeholder.com/40'}" alt="${notification.from.username || 'Unknown User'}">
                    <span>${notification.message}${notification.from.verified ? '<span class="verified-tick">✅</span>' : ''}</span>
                `;
                notificationDiv.onclick = async () => {
                    try {
                        await fetch(`${API_BASE_URL}/api/notifications/${notification._id}/read`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        if (notification.from._id !== currentUser._id) {
                            showSection('otherProfileSection', notification.from._id);
                        }
                    } catch (error) {
                        console.error('Failed to mark notification as read:', error);
                    }
                };
                notificationList.appendChild(notificationDiv);
            }
        }

        const unreadCount = notifications.filter(n => !n.read).length;
        notificationCount.style.display = unreadCount > 0 ? 'inline' : 'none';
        notificationCount.textContent = unreadCount;
    } catch (error) {
        displayError(error.message.includes('Failed to fetch') ? 'Network error: Unable to connect to server.' : error.message);
    }
}
</script>
</body>
</html>
